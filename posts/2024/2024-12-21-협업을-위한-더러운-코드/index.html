<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>협업을 위한 더러운 코드 | blog.blu3fishez</title>
<meta name="keywords" content="clean_code">

<meta name="description" content="문제 상황 스터디 세션을 리팩토링 과정에서 코드가 길어져서 고민을 했었습니다. 특히나 비즈니스 로직과 레포지토리 코드가 혼재 해 있었고, 그 부분에서 하나의 핸들러가 호출하는 로직에서 서비스.. 레포지토리.. 이렇게 다양한 계층을 따라 로직이 퍼져있었습니다.
예를 들면, 레포지토리에서는 데이터 베이스 (혹은 자료 저장소) 에 관해서 어떤 정보가 저장되어 있어야하는지
그래서 해당 부분을 리팩토링을 시도했으나, 오히려 팀의 성장에 방해가 되었습니다. 그 부분에 있어서는 조금 더 깔끔한 코드와 프로토콜을 만들고자 하는 욕심 이 1순위로 작용했던 것이 아닐까 하고 회고하면서 판단해봅니다.
">
<meta name="author" content="blu3fishez">
<link rel="canonical" href="https://blog.blu3fishez.org/posts/2024/2024-12-21-%ED%98%91%EC%97%85%EC%9D%84-%EC%9C%84%ED%95%9C-%EB%8D%94%EB%9F%AC%EC%9A%B4-%EC%BD%94%EB%93%9C/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.d3f251795b1b2227fec87dbd9339a39a72025c1e2678c7b78fdbf5213fbef45d.css" integrity="sha256-0/JReVsbIif&#43;yH29kzmjmnICXB4meMe3j9v1IT&#43;&#43;9F0=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.blu3fishez.org/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.blu3fishez.org/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.blu3fishez.org/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.blu3fishez.org/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.blu3fishez.org/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://blog.blu3fishez.org/posts/2024/2024-12-21-%ED%98%91%EC%97%85%EC%9D%84-%EC%9C%84%ED%95%9C-%EB%8D%94%EB%9F%AC%EC%9A%B4-%EC%BD%94%EB%93%9C/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://blog.blu3fishez.org/posts/2024/2024-12-21-%ED%98%91%EC%97%85%EC%9D%84-%EC%9C%84%ED%95%9C-%EB%8D%94%EB%9F%AC%EC%9A%B4-%EC%BD%94%EB%93%9C/">
  <meta property="og:site_name" content="blog.blu3fishez">
  <meta property="og:title" content="협업을 위한 더러운 코드">
  <meta property="og:description" content="문제 상황 스터디 세션을 리팩토링 과정에서 코드가 길어져서 고민을 했었습니다. 특히나 비즈니스 로직과 레포지토리 코드가 혼재 해 있었고, 그 부분에서 하나의 핸들러가 호출하는 로직에서 서비스.. 레포지토리.. 이렇게 다양한 계층을 따라 로직이 퍼져있었습니다.
예를 들면, 레포지토리에서는 데이터 베이스 (혹은 자료 저장소) 에 관해서 어떤 정보가 저장되어 있어야하는지
그래서 해당 부분을 리팩토링을 시도했으나, 오히려 팀의 성장에 방해가 되었습니다. 그 부분에 있어서는 조금 더 깔끔한 코드와 프로토콜을 만들고자 하는 욕심 이 1순위로 작용했던 것이 아닐까 하고 회고하면서 판단해봅니다.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-12-21T12:34:38+09:00">
    <meta property="article:modified_time" content="2024-12-21T12:34:38+09:00">
    <meta property="article:tag" content="Clean_code">
      <meta property="og:image" content="https://blog.blu3fishez.org/images/papermod-cover.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://blog.blu3fishez.org/images/papermod-cover.png">
<meta name="twitter:title" content="협업을 위한 더러운 코드">
<meta name="twitter:description" content="문제 상황
스터디 세션을 리팩토링 과정에서 코드가 길어져서 고민을 했었습니다. 특히나 비즈니스 로직과 레포지토리 코드가 혼재 해 있었고, 그 부분에서 하나의 핸들러가 호출하는 로직에서 서비스.. 레포지토리.. 이렇게 다양한 계층을 따라 로직이 퍼져있었습니다.
예를 들면, 레포지토리에서는 데이터 베이스 (혹은 자료 저장소) 에 관해서 어떤 정보가 저장되어 있어야하는지
그래서 해당 부분을 리팩토링을 시도했으나, 오히려 팀의 성장에 방해가 되었습니다. 그 부분에 있어서는 조금 더 깔끔한 코드와 프로토콜을 만들고자 하는 욕심 이 1순위로 작용했던 것이 아닐까 하고 회고하면서 판단해봅니다.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.blu3fishez.org/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "협업을 위한 더러운 코드",
      "item": "https://blog.blu3fishez.org/posts/2024/2024-12-21-%ED%98%91%EC%97%85%EC%9D%84-%EC%9C%84%ED%95%9C-%EB%8D%94%EB%9F%AC%EC%9A%B4-%EC%BD%94%EB%93%9C/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "협업을 위한 더러운 코드",
  "name": "협업을 위한 더러운 코드",
  "description": "문제 상황 스터디 세션을 리팩토링 과정에서 코드가 길어져서 고민을 했었습니다. 특히나 비즈니스 로직과 레포지토리 코드가 혼재 해 있었고, 그 부분에서 하나의 핸들러가 호출하는 로직에서 서비스.. 레포지토리.. 이렇게 다양한 계층을 따라 로직이 퍼져있었습니다.\n예를 들면, 레포지토리에서는 데이터 베이스 (혹은 자료 저장소) 에 관해서 어떤 정보가 저장되어 있어야하는지\n그래서 해당 부분을 리팩토링을 시도했으나, 오히려 팀의 성장에 방해가 되었습니다. 그 부분에 있어서는 조금 더 깔끔한 코드와 프로토콜을 만들고자 하는 욕심 이 1순위로 작용했던 것이 아닐까 하고 회고하면서 판단해봅니다.\n",
  "keywords": [
    "clean_code"
  ],
  "articleBody": "문제 상황 스터디 세션을 리팩토링 과정에서 코드가 길어져서 고민을 했었습니다. 특히나 비즈니스 로직과 레포지토리 코드가 혼재 해 있었고, 그 부분에서 하나의 핸들러가 호출하는 로직에서 서비스.. 레포지토리.. 이렇게 다양한 계층을 따라 로직이 퍼져있었습니다.\n예를 들면, 레포지토리에서는 데이터 베이스 (혹은 자료 저장소) 에 관해서 어떤 정보가 저장되어 있어야하는지\n그래서 해당 부분을 리팩토링을 시도했으나, 오히려 팀의 성장에 방해가 되었습니다. 그 부분에 있어서는 조금 더 깔끔한 코드와 프로토콜을 만들고자 하는 욕심 이 1순위로 작용했던 것이 아닐까 하고 회고하면서 판단해봅니다.\n협업의 본질을 잊어버리고 스터디 기능 자체를 1일만에 개발한 건 분명 좋은 발전이었으나, 그만큼 3일을 팀 입장에서는 허비시키게 만들었습니다.\n사실 이벤트 명을 바꾼건 크게 문제가 되지 않았습니다. 그냥 바꾸면 되니까요. 그런데 문제는 이런 점이었습니다.\n![[Pasted image 20241228220445.webp]]\n위 내용은 제 리팩토링(이라는 이름의 리워크)에 영향받은, 저희 팀원의 스크럼 내용입니다. 이게 과연 협업일까요..? 이때 스스로 많이 반성하게 되었습니다. 스스로 협업을 위한 코드랍시고 나만을 위한 깔끔한 코드를 짜려고 했던 것 같았습니다.\n해결 시도 과정 결국 잘 모르겠어서 멘토님께 여쭤보았습니다. 부스트캠프에서 주어진 팀 멘토링 시간을 활용하였고, 글로 남겨서 정리하여 멘토님께 질문드려봤습니다. 이때까지만 해도 저는 나만을 위한 깔끔한 코드 에 집착하고 있었고, 이에 아래와 같이 질문하게 되었습니다.\n질문\n스터디 세션 부분을 리팩토링하면서 고민을 많이했었습니다.. 아예 구조 자체를 바꿔버리는 스펙이 변경되는 규모에서 100줄 이상 길어지는 코드를 여러 파일로 나누어 관리하다보니 아예 함수 (방을 나가는 로직) 만을 위한 서비스 클래스를 작성하게 되었고, 구별하게 되었는데 결론적으로는 예전보다는 보기가 쉽다고 팀 내부적으로 결론이 났었습니다.\n그런데 이게 나중에 가서 최적화 측면에서 문제가 될 지 궁금합니다. 실제로 클래스 기반으로 함수를 짜실 때 멘토님께서는 어떤 방식으로 길어지는 로직을 분리하시거나 관리하시는지 궁금합니다.\n멘토님의 답변\n가독성은 사실 주관적인 것입니다. 그래서 저는 클래스 기반으로 함수를 짜는 것은 개인적으로 추천하지 않습니다. 보통 재사용성이 높은 코드를 분리하는게 가독성이 좋다고 합니다. 그렇다고 두세번 쓰인다고 무조건 분리하는 것은 추천하지 않습니다.\n보통 코드의 줄수를 줄이기만을 위해 고치려고 하지는 않습니다. 코드가 길어져도 분명한 역할이 있다면 그대로 두는게 맞다고 생각합니다. 많이 쓰이는 오픈소스 라이브러리들 중에서도 한 파일에 천 줄이 넘는 코드가 많습니다. 물론 구조화가 잘 되어서 나눠지면 좋지만, 그럴 수 없는 경우도 많으며 이때 코드가 길기 때문에 분리해야한다!는 곤란하다고 생각합니다. 오히려 한 파일에 긴 코드가 있는게 더 가독성이 높을 때도 많습니다. 코드의 길이보다도 구조에 중점을 두는게 더 좋을 때도 있습니다. 그러니, 확장 가능성을 고려해서 구조화를 하고, 분리를 해보세요\n멘토님께서는 실제로 클린코드와 같은 개념에 대해 의식하고 계신 것 같았습니다. 저도 실제로 클린 코드의 위험성에 대해 인지는 하고 있었지만, 멘토님께서는 많이 우려스러운 답변을 주셔서 저도 속으로는 의아했습니다.\nimport { RoomDto } from \"@/room/dto/room.dto\"; import { RoomRepository } from \"@/room/room.repository\"; import { Injectable } from \"@nestjs/common\"; @Injectable() export class RoomHostService { public constructor(private readonly roomRepository: RoomRepository) {} private getNewHost(room: RoomDto) { return Object.values(room.connectionMap).sort((a, b) =\u003e a.createAt - b.createAt)[0]; } public async delegateHost(roomId: string) { const room = await this.roomRepository.getRoom(roomId); if (!room) throw new Error(\"Invalid room Id\"); const newHost = this.getNewHost(room); const found = room.connectionMap[newHost.socketId]; if (!found) throw new Error(\"invalid new host id\"); room.host = newHost; await this.roomRepository.setRoom(room); return newHost; } } 위 방식도 Nest.js 에서 각각의 의존성이 어떻게 관리되고 있는지 생각해봐야합니다.\nNest.js 에서 의존성을 관리하는 방법 기본적으로 Nest.js 에서는 의존성을 하나의 인스턴스(싱글턴 객체)로 생성하여 관리하고 있습니다. 그렇게 될 경우, 서비스를 마구잡이로 나눌 경우, 제아무리 싱글턴 객체라도 메모리를 차지하는 것은 어쩔 수 없는 사실입니다.\n물론, 멘토님께서도 완벽히 위와같은 코드를 분리하는 것에 반대를 하지 않으셨고, 애매한 상황이라고 말씀해주시긴 하셨습니다. 무엇이든 정답이 없습니다. 하나의 방법이 정답이라고 생각했던 것이 잘못되었다고 생각했습니다. 이번 케이스에서는 프론트엔드 개발자분의 스펙 변경에 대해서 고려하지 않고, 단순히 코드의 가독성만을 위해서 구조를 나눈 것이 주객전도됨을 깨달았습니다.\n특히나, 확장성을 고려하여 roomService 의 인터페이스를 맞추지 않았어서 문제가 되었습니다. 실제로 이렇게 편하게 보기위해 코드를 짰을 경우, 외부 모듈에서 참조를 하게 되는 경우 roomService가 아니라 roomHostService를 불러와야하는지 어떤걸 불러와야 적용할 수 있는지 확인할 수 없었습니다. 처음 적용할 때 roomService 에 없는 것을 보고 엥? 싶을 것이다 생각이 들었습니다.\n특히나 리턴되는 값을 마구잡이로 바꿔가면서 테스트 코드의 중요성을 깨닫게 되었습니다. 리팩토링을 할 때 테스트 코드를 통해 스펙을 고정하고 리팩토링을 하게 되어야함을 깨달았습니다.\n코드가 500줄이 되던 400줄이 되던, 실제 오픈 소스 코드는 1000줄이 되더라도, 특정 클래스가 수행하는 역할을 잘 수행한다면 상관없다라는 부분에서 깨달음을 얻었습니다. 확실히, 방을 생성하는 것만 roomService 가 아닌, roomCreateService 에서 불러오는 게 확실히 이상하다고 생각이 들었습니다.\n리팩토링을 올바르게 하기 위한 과제 확장성을 염두에 두고 설계하기 사실 제가 생각하기에 서비스를 나눌 때 과하게 나누었다고 생각은 들었습니다.\n![[Pasted image 20241228220621.webp]]\n현재 제가 리팩토링한 서비스들을 폴더로 depth를 두어, 각각의 기능은 각각의 서비스에서 하는 식으로 함수 하나가 길어지는 경우를 나누어서 관리하기 편하도록 만들었습니다. 그리고, 아래 코드는 실제 room-create.service.ts 코드입니다.\nimport { Injectable } from \"@nestjs/common\"; import { CreateRoomInternalDto } from \"@/room/dto/create-room.dto\"; import { EMIT_EVENT } from \"@/room/room.events\"; import { WebsocketService } from \"@/websocket/websocket.service\"; import { RoomRepository } from \"@/room/room.repository\"; import { QuestionListRepository } from \"@/question-list/question-list.repository\"; import { RoomJoinService } from \"@/room/services/room-join.service\"; import { createHash } from \"node:crypto\"; import \"dotenv/config\"; @Injectable() export class RoomCreateService { private static ROOM_ID_CREATE_KEY = \"room_id\"; public constructor( private readonly roomRepository: RoomRepository, private readonly socketService: WebsocketService, private readonly questionListRepository: QuestionListRepository, private readonly roomJoinService: RoomJoinService ) {} public async createRoom(dto: CreateRoomInternalDto) { const { socketId, nickname } = dto; const id = await this.generateRoomId(); const socket = this.socketService.getSocket(socketId); const currentTime = Date.now(); const questionListContents = await this.questionListRepository.getContentsByQuestionListId( dto.questionListId ); const roomDto = { ...dto, id, inProgress: false, connectionMap: {}, participants: 0, questionListContents, createdAt: currentTime, host: { socketId: dto.socketId, nickname, createAt: currentTime, }, }; await this.roomRepository.setRoom(roomDto); socket.emit(EMIT_EVENT.CREATE, roomDto); } // TODO: 동시성 고려해봐야하지 않을까? private async generateRoomId() { const client = this.socketService.getRedisClient(); const idString = await client.get(RoomCreateService.ROOM_ID_CREATE_KEY); let id: number; if (idString \u0026\u0026 !isNaN(parseInt(idString))) { id = await client.incr(RoomCreateService.ROOM_ID_CREATE_KEY); } else { id = parseInt(await client.set(RoomCreateService.ROOM_ID_CREATE_KEY, \"1\")); } return createHash(\"sha256\") .update(id + process.env.SESSION_HASH) .digest(\"base64url\"); } } 코드의 줄 수에 연연하지 않고, 객체의 책임을 생각해보기 코드의 줄 수가 많으면 읽기 힘드신 분이 많으신가요, 아니면 코드가 길어도 인터페이스만 깔끔하면 선호하시나요? 저는 저만의 방법을 많이 생각을 많이했고, 특히 DTO 와 엔티티 의 형태가 조잡하게 변환이 되고 있었음을 깨달았습니다. 그래서 형태를 일관적으로 유지하는 것에 대해서 신경쓰는게 중요하다는 것을 파악했습니다.\n일단 첫번째로, API 의 입출력 형태를 맞추기 위한 DTO를 설정했습니다.\nimport { ArrayMaxSize, ArrayMinSize, IsArray, IsEnum, IsNotEmpty, IsNumber, Max, Min, } from \"class-validator\"; import { Connection, RoomStatus } from \"@/room/domain/room\"; import { Question } from \"@/question-list/entity/question.entity\"; export class CreateRoomDto { private static MAX_CATEGORY_SIZE = 3; private static MIN_CATEGORY_SIZE = 1; private static MAX_PARTICIPANT_SIZE = 5; private static MIN_PARTICIPANT_SIZE = 1; @IsNotEmpty() title: string; @IsEnum(RoomStatus, { message: \"Status must be either PUBLIC or PRIVATE\", }) status: RoomStatus; @IsNotEmpty() nickname: string; @IsNotEmpty() @IsArray() @ArrayMaxSize(CreateRoomDto.MAX_CATEGORY_SIZE) @ArrayMinSize(CreateRoomDto.MIN_CATEGORY_SIZE) category: string[]; @IsNumber() @Min(CreateRoomDto.MIN_PARTICIPANT_SIZE) @Max(CreateRoomDto.MAX_PARTICIPANT_SIZE) maxParticipants: number; @IsNumber() questionListId: number; } export interface CreateRoomResponseDto { title: string; status: RoomStatus; nickname: string; maxParticipants: number; category: string[]; questionListId: number; socketId: string; id: string; inProgress: boolean; connectionMap: Record\u003cstring, Connection\u003e; participants: number; questionListContents: Question[]; createdAt: number; host: Connection; } 이렇게 반환 값을 정해버리는 순간, 리팩토링을 하면서 API를 변경할 일이 없어졌습니다. 어쨌거나 타입스크립트 컴파일러 단에서 잡아주니까, 보다 안정적으로 리팩토링할 수 있었습니다.\n두번째로, 이런 DTO들을 통해 레포지토리에 연관되고 있음을 깨달았습니다.\nimport { Injectable } from \"@nestjs/common\"; import { InjectRepository } from \"@moozeh/nestjs-redis-om\"; import { Repository } from \"redis-om\"; import { RoomEntity } from \"@/room/room.entity\"; import { RoomDto } from \"@/room/dto/room.dto\"; @Injectable() export class RoomRepository { public constructor( @InjectRepository(RoomEntity) private readonly roomRepository: Repository\u003cRoomEntity\u003e ) {} // TODO : .from 메서드 구현 필요? public async getAllRoom(): Promise\u003cRoomDto[]\u003e { const allRooms = await this.roomRepository.search().return.all(); return allRooms.map((room: RoomEntity) =\u003e { const connectionMap = JSON.parse(room.connectionMap || \"{}\"); return { connectionMap: JSON.parse(room.connectionMap || \"{}\"), createdAt: room.createdAt, host: JSON.parse(room.host), maxParticipants: room.maxParticipants, maxQuestionListLength: room.maxQuestionListLength, questionListId: room.questionListId, questionListTitle: room.questionListTitle, currentIndex: room.currentIndex, status: room.status, title: room.title, id: room.id, category: room.category, inProgress: room.inProgress, participants: Object.keys(connectionMap).length, }; }); } public async getRoom(id: string): Promise\u003cRoomDto\u003e { const room = await this.roomRepository.search().where(\"id\").eq(id).return.first(); if (!room) return null; const connectionMap = JSON.parse(room.connectionMap || \"{}\"); return { category: room.category, inProgress: room.inProgress, connectionMap, createdAt: room.createdAt, currentIndex: room.currentIndex, maxQuestionListLength: room.maxQuestionListLength, questionListId: room.questionListId, questionListTitle: room.questionListTitle, host: JSON.parse(room.host), participants: Object.keys(connectionMap).length, maxParticipants: room.maxParticipants, status: room.status, title: room.title, id: room.id, }; } public async setRoom(dto: RoomDto): Promise\u003cvoid\u003e { const room = new RoomEntity(); room.id = dto.id; room.category = dto.category; room.inProgress = dto.inProgress; room.title = dto.title; room.status = dto.status; room.currentIndex = dto.currentIndex; room.connectionMap = JSON.stringify(dto.connectionMap); room.maxParticipants = dto.maxParticipants; room.maxQuestionListLength = dto.maxQuestionListLength; room.questionListId = dto.questionListId; room.questionListTitle = dto.questionListTitle; room.createdAt = Date.now(); room.host = JSON.stringify(dto.host); await this.roomRepository.save(room.id, room); } public async removeRoom(id: string): Promise\u003cvoid\u003e { const entities = await this.roomRepository.search().where(\"id\").equals(id).return.all(); for await (const entity of entities) { await this.roomRepository.remove(entity.id); } } } 보시면 redis-om 으로 인해 객체의 직렬화를 일일이 해주고 있었습니다. 레포지토리는 순전히 엔티티를 반영하고 가져오기만을 해야한다고 생각했습니다. 그것이 명확한 책임의 경계선이라고 생각했고, 각자의 도메인마다 필요한 객체의 직렬화가 필요한 프로퍼티를 어떻게 할지 기술적으로 어려움에 직면했습니다.\n문제 해결 과정 1. Facade 패턴으로 redis-om 엔티티에 도메인 로직 결합하기 확장성 있는 설계를 하라는 멘토님의 말씀을 듣고 고민을 하게 되었습니다. 그래서 현재 제가 리팩토링했던 세션 백엔드 코드 부분(room)에서 어떤 문제가 있는지 고민해본 결과, 현재 redis entity 로 매번 변환 과정을 거치고, 서비스나 레포지토리에서 형변환을 하여 엔티티에 넣는게 과연 맞는지 의문이 들었습니다.\n이후 최근에 다른 부캠에서 수료한 친구와 논의도 해보며 Claude 로도 검색을 해서 찾아보았고, 그 과정에서 DDD 라는 용어가 있음을 알게 됐고, 당연히 앞서 언급된 클린코드처럼 해당 개발방법론에 대해서도 주의할 필요가 있었습니다.\nDDD 의 정의..? ⚠ DDD를 적용했다는 의미가 아닙니다.\n사실 넓은 의미에서 DDD가 어떤건지도 잘 모를 뿐더러, 지금 적용하기에는 시간이 많이 부족하다고 생각이 들었습니다. 정의 자체에 대한 내용은 많이 나와있습니다. 간략하게 얘기하면, DDD는 복잡한 소프트웨어를 개발할 때 비즈니스 도메인을 중심으로 설계하고 개발하는 방법론입니다.\n저는 DDD가 제공하는 모든 개념을 사용하진 않았고, 단지 비즈니스 도메인의 역할에 집중하자 라는 문장 한마디로 시작했습니다.\n여태까지 서비스, 컨트롤러 등 데이터보다는 사실 로직에 중심을 두었습니다. 모델의 경우도 단순 interface 로 두고 이 객체의 실제 세상에서의 역할 보다, 그저 컴퓨터 세상에서의 자료형 에 집중했던 것 같습니다.\nDDD 라는 개념을 도입하면서 또 클린 코드에 집착하는 것 아니냐 할 수 있겠습니다. 하지만 DDD에서 나온 도메인 로직에 대한 관심분리는 현재 제 프로젝트에 있어서 필요하다고 판단을 했습니다. 또한, 실제로 프론트엔드에서 변경요청이 잦기도 하고, 앞서 겪었던 스펙 변경에 따른 변경과 소통의 혼선이 잦았습니다.\n특히나, DTO 를 변환하는 로직이 중복되고 있음을 확인했고, 객체의 형변환이나 검증 로직이 자주 사용되거나, 역할의 책임이 결합되어있으므로 분리되어야함을 깨달았습니다.\n이때 다만 실제로 DDD를 적용하지 않고, 마냥 받아들이는 것이 좋지 않다는 경험을 이전에 클린코드와 관련해 멘토님과 논의해봤던 것을 다시 회상하였고, DDD 에서 쓰이는 개념을 가져오기로 했습니다.\n첫번째 해결 시도 : redis-om 엔티티를 상속받기 첫번째 시도는 바로 현재 사용중인 redis-om 에 접근 제한자와 setter,getter 를 넣자는 생각이었습니다. 저는 여태까지 모델에 로직을 넣으면 안돼! 라는 틀에 박힌 생각을 해왔었습니다만, 이번엔 그냥 제가 편하고 관리가 편하면 되지라는 마인드로 도전해보았습니다.\n하지만 이때 첫번째 문제가 생겼습니다. 바로 nestjs-edis-om 라는 외부라이브러리에서 Schema 에서는 함수 프로퍼티를 무시해서 보내주지 않았습니다.\n![[Pasted image 20241230161928.webp]] redisom 어댑터를 쓰기엔 기능 확장이 부족했다..\n해당 라이브러리인 nestjs-redis-om 라이브러리를 직접 고치기 위해 제가 포크도 하였지만, 시간과 비용이 많이 발생할 것이라고 예측했습니다.\nRedis 에서 데이터를 저장하는 방식 Redis 에서 데이터를 저장할 때, 객체를 저장할 수 있습니다. 하지만, 각 객체의 프로퍼티는 직렬화가 필수인데요.\n![[Pasted image 20241230162006.webp]]\n![[Pasted image 20241230162020.webp]]\n실제로 저는 복잡한 객체를 바로바로 제공할 수 있도록 하려고 했고, 연결 정보 자체에 대한 메타데이터들을 room 객체 하위에 connectionMap 이라는 JSON 객체로 저장하고 있습니다.\n사실 지금 보면 이를 별도의 도메인으로 만들어 따로 저장해야한다고 생각합니다. 하지만 결국, 이를 따로 키로써 저장하게 되면 키를 조회를 많이 하게 됩니다. 싱글스레드인 레디스에서는 최대한 키를 검색하는 과정을 줄여야한다고 생각했습니다.\n그렇기에 결국 키를 하나로 저장하려면 직렬화는 필수였습니다. 그래서 이를 위해서는 해당 room 객체의 직렬화 와 역직렬화만을 위한 별도의 로직 함수들이 자주 사용될 것이라고 생각했습니다.\n그래서 이렇게 자주 사용되는 도메인 로직을 직접 분리해보기로 했고, 이게 진정한 확장성 있는 설계라고 생각이 들었습니다.\n두번째 해결 시도 : 엔티티와 도메인을 넘나드는 도메인 서비스 그러면 일단 가장 간단하게 자주 사용되는 로직을 분리하는 방법은 뭘까요? 그것은 바로 도메인 로직만을 담은 roomDomainService 를 만드는 방법입니다.\n이 방법도 괜찮은 방법이라고 생각했습니다. 아래와 같은 repository 코드를 보면, 실제로 직렬화와 역직렬화를 같이 맡고 있어서 자주 사용되고 있습니다.\nimport { Injectable } from \"@nestjs/common\"; import { InjectRepository } from \"@moozeh/nestjs-redis-om\"; import { Repository } from \"redis-om\"; import { RoomEntity } from \"@/room/room.entity\"; import { RoomDto } from \"@/room/dto/room.dto\"; @Injectable() export class RoomRepository { public constructor( @InjectRepository(RoomEntity) private readonly roomRepository: Repository\u003cRoomEntity\u003e ) {} // TODO : .from 메서드 구현 필요? public async getAllRoom(): Promise\u003cRoomDto[]\u003e { const allRooms = await this.roomRepository.search().return.all(); return allRooms.map((room: RoomEntity) =\u003e { const connectionMap = JSON.parse(room.connectionMap || \"{}\"); return { connectionMap: JSON.parse(room.connectionMap || \"{}\"), createdAt: room.createdAt, host: JSON.parse(room.host), maxParticipants: room.maxParticipants, maxQuestionListLength: room.maxQuestionListLength, questionListId: room.questionListId, questionListTitle: room.questionListTitle, currentIndex: room.currentIndex, status: room.status, title: room.title, id: room.id, category: room.category, inProgress: room.inProgress, participants: Object.keys(connectionMap).length, }; }); } public async getRoom(id: string): Promise\u003cRoomDto\u003e { const room = await this.roomRepository.search().where(\"id\").eq(id).return.first(); if (!room) return null; const connectionMap = JSON.parse(room.connectionMap || \"{}\"); return { category: room.category, inProgress: room.inProgress, connectionMap, createdAt: room.createdAt, currentIndex: room.currentIndex, maxQuestionListLength: room.maxQuestionListLength, questionListId: room.questionListId, questionListTitle: room.questionListTitle, host: JSON.parse(room.host), participants: Object.keys(connectionMap).length, maxParticipants: room.maxParticipants, status: room.status, title: room.title, id: room.id, }; } public async setRoom(dto: RoomDto): Promise\u003cvoid\u003e { const room = new RoomEntity(); room.id = dto.id; room.category = dto.category; room.inProgress = dto.inProgress; room.title = dto.title; room.status = dto.status; room.currentIndex = dto.currentIndex; room.connectionMap = JSON.stringify(dto.connectionMap); room.maxParticipants = dto.maxParticipants; room.maxQuestionListLength = dto.maxQuestionListLength; room.questionListId = dto.questionListId; room.questionListTitle = dto.questionListTitle; room.createdAt = Date.now(); room.host = JSON.stringify(dto.host); await this.roomRepository.save(room.id, room); } public async removeRoom(id: string): Promise\u003cvoid\u003e { const entities = await this.roomRepository.search().where(\"id\").equals(id).return.all(); for await (const entity of entities) { await this.roomRepository.remove(entity.id); } } } 하지만 이런 상황을 생각해봅시다.\n가장 간단한 방법이라곤 해도, 매번 엔티티의 상태 를 업데이트해서 넘겨주는게 불편하다고 생각했습니다. 또한, 포함관계 가 명확하지 않아서, 어쩔 때는 entity 만을 가지고 모든 걸 수행해야한다는 것에서 통일성이 없을 것 같다고 생각이 들었습니다.\n두번째 해결 시도의 문제점 가장 무엇보다 명확한 문제는 역직렬화를 한번만 해서 정보를 가지고 있고, 필요할 때 직렬화를 하게 해주는 작업을 위한 메소드를 사용할 때 매번 엔티티를 필요로 하기 때문에 역직렬화 상태를 저장할 수 없다는 점입니다.\n이를 생각하게 되면, 역직렬화 상태와 직렬화 상태의 객체를 동시에 가지고 다루어야한다는 문제가 생깁니다. 이렇게 되면 헷갈리게 되어 생산성에 방해가 되었습니다.\n예를 들면, RoomEntity 객체와 RoomDomain 객체를 매번 순환하여 저장하는 식으로 변수에 저장하게 되는 상황인 것이죠. 이렇게 되면 실제로 기능 확장 시 RoomDomain 을 쓸 지, RoomEntity 를 쓸 지 헷갈리게 됩니다.\n의존성에 관한 문제도 있을 것입니다. Room 도메인이 사용되는 상황에서는 매번 RoomService 가 따라오겠지요. 하지만 이는 Nest 생태계에서의 의존성 관리 덕분에 큰 문제는 아니라고 판단했습니다.\n가장 간단한 방법이 무엇일까? 이전에는 가장 깔끔한 방법을 찾았지만, 이제는 가장 손이 안가는 방법 을 찾는 데에 집중하게 되었습니다. 결국 제가 생각해본 도메인 로직 코드는 아래와 같았습니다.\n그리고, 가장 하고 싶었던 건 도메인(단순 할당 등)의 작업 단위 를 한 데 묶고 싶었고, 경우에 따라 로직으로 처리해야할 것은 로직으로 처리하고 싶었습니다.\n실제로 위 코드의 Repository 코드에서 수행하던 변환 로직을 이쪽에서 수행하여, 매번 역직렬화 과정을 거치지 않도록 만들었습니다.\nimport { RoomEntity } from \"@/room/room.entity\"; export interface Connection { socketId: string; nickname: string; createAt: number; } export enum RoomStatus { PUBLIC = \"PUBLIC\", PRIVATE = \"PRIVATE\", } export interface IRoom { id: string; title: string; category: string[]; inProgress: boolean; currentIndex: number; host: Connection; status: RoomStatus; maxParticipants: number; maxQuestionListLength: number; questionListId: number; questionListTitle: string; createdAt: number; connectionMap: Record\u003cstring, Connection\u003e; } export class Room { public entity: RoomEntity; constructor(entity?: IRoom) { if (!entity) { this.entity = null; return this; } this.entity = new RoomEntity(); this.entity.id = entity.id; this.entity.status = entity.status; this.setConnection(entity.connectionMap); this.entity.title = entity.title; this.entity.createdAt = entity.createdAt; this.entity.questionListId = entity.questionListId; this.entity.questionListTitle = entity.questionListTitle; this.entity.inProgress = entity.inProgress; this.entity.maxParticipants = entity.maxParticipants; this.entity.currentIndex = entity.currentIndex; this.entity.category = entity.category; this.entity.maxQuestionListLength = entity.maxQuestionListLength; this.entity.host = JSON.stringify(entity.host); } static fromEntity(entity: RoomEntity) { const room = new Room(); room.entity = entity; return room; } build() { return this.entity; } toObject(): IRoom { return { id: this.entity.id, status: this.entity.status, connectionMap: this.getConnection(), title: this.entity.title, createdAt: this.entity.createdAt, questionListId: this.entity.questionListId, questionListTitle: this.entity.questionListTitle, inProgress: this.entity.inProgress, maxParticipants: this.entity.maxParticipants, currentIndex: this.entity.currentIndex, category: this.entity.category, maxQuestionListLength: this.entity.maxQuestionListLength, host: this.getHost(), }; } setHost(connection: Connection) { this.entity.host = JSON.stringify(connection); return this; } getHost(): Connection { return JSON.parse(this.entity.host); } setConnection(connectionMap: Record\u003cstring, Connection\u003e) { this.entity.connectionMap = JSON.stringify(connectionMap); return this; } getConnection(): Record\u003cstring, Connection\u003e { return JSON.parse(this.entity.connectionMap); } getParticipants(): number { return Object.keys(this.getConnection()).length; } addConnection(connection: Connection) { const connectionMap = this.getConnection(); connectionMap[connection.socketId] = connection; return this.setConnection(connectionMap); } removeConnection(socketId: string) { const connectionMap = this.getConnection(); delete connectionMap[socketId]; return this.setConnection(connectionMap); } } 촉박한 시간관계상 직렬화 역직렬화 등의 필수적인 도메인 로직만을 구현했고, 엔티티를 캡슐화를 일부러 풀어서 다른 프로퍼티의 경우 getter setter 구현 없이 직접 접근하도록 만들었습니다. 이렇게 리팩토링했을 경우 부캠이 끝나고 천천히 리팩토링할 때 도메인 클래스로 마이그레이션 하기 쉽다고 판단했습니다.\n그리고 알고보니, 해당 구현 방식은 실제로 존재하는 디자인 패턴이었고, Facade 디자인 패턴을 제가 완전히 활용하고 있었습니다!\nFacade 패턴이란? Facade 디자인 패턴이란 복잡한 서브 시스템에 대한 간단한 인터페이스를 제공하는 구조적 디자인 패턴입니다.\n# 복잡한 서브시스템 클래스들 class CPU: def freeze(self): print(\"CPU 동결\") def execute(self): print(\"CPU 실행\") class Memory: def load(self): print(\"메모리 로드\") class HardDrive: def read(self): print(\"하드드라이브 읽기\") # Facade 클래스 class ComputerFacade: def __init__(self): self.cpu = CPU() self.memory = Memory() self.hard_drive = HardDrive() def start(self): # 복잡한 시작 과정을 단순화 self.cpu.freeze() self.memory.load() self.hard_drive.read() self.cpu.execute() # 클라이언트 코드 computer = ComputerFacade() computer.start() # 단순히 start() 메서드만 호출하면 됨 프랑스어로 건물의 외벽 이라고 부르는 Facade 는 복잡한 시스템(엔티티의 직렬화) 를 간단한 인터페이스로 만들어서 사용하기 쉽게 만들 수 있습니다.\n그 결과 서비스 코드 그 이후 서비스 코드들이 도메인 설정에 관한 로직이 간단해졌습니다.\n첫번째 예시 : 캡슐화를 통한 서비스에서의 도메인 관심 분리 // 바뀐 서비스 코드 public async setProgress(roomId: string, socketId: string, status: boolean) { const room = Room.fromEntity(await this.roomRepository.getRoom(roomId)); if (!room.entity) throw new Error(\"cannot set progress\"); if (room.getHost().socketId !== socketId) throw new Error(\"only host can set process\"); room.entity.inProgress = status; if (!room.entity.inProgress) room.entity.currentIndex = 0; await this.roomRepository.setRoom(room.build()); return status; } 명시적으로 직렬화 하는 과정을 캡슐화함으로써, 로직 수행에만 집중할 수 있도록 만들었던 것 같습니다. 이전보다 할당문이 많이 줄었습니다. 이부분은 getter setter 를 두어서, 보다 일관되게 처리할 수 있습니다.\n// 이전 코드 public async setProgress(roomId: string, socketId: string, status: boolean) { const room = await this.roomRepository.getRoom(roomId); if (!room) throw new Error(\"cannot set progress\"); if (room.host.socketId !== socketId) throw new Error(\"only host can set process\"); room.inProgress = status; if (!room.inProgress) room.currentIndex = 0; await this.roomRepository.setRoom(room); return status; } 두번째 예시 : 확장 가능한 DTO 변환 로직의 생성 가능 두번째 예시입니다. 이는 room-create.service.ts 로 나누었던 함수입니다. 실제로 dto를 받고 객체로써 새로운 방을 레포지토리에 바로 엔티티로써 보내줄 수 없었던 단점을 해결할 수 있었습니다.\n현재 보시면, 아래 코드의 큰 차이는 엔티티로 넘겨주는 지에 대한 여부의 차이입니다. 그냥 객체로 쓰면 안될까? 라고 할 수 있겠지만, 실제로 제가 원하는 시점에 언제 엔티티로 만들 수 있는지도 중요합니다.\n최적화 여부도 있겠습니다. repository 에 업데이트를 자주해야하는 상황이 온다면, 이미 도메인 객체가 갖고 있는 엔티티를 리턴하면 됩니다. 이전 코드대로라면 repository 에 참조할 때마다 변환 과정이 무조건 일어나는 상황이 생깁니다.\n또한 각각의 DTO는 동일한 역직렬화된 도메인으로부터 필요한 데이터를 꺼내올 수 있도록 만들 수 있었습니다. 적어도 직렬화와 역직렬화 라는 관심에서는 벗어난거죠. DTO 변환만을 위한 작업을 수행할 수 있게된 것입니다.\n@Transactional() public async createRoom(dto: CreateRoomInternalDto) { const { socketId, nickname } = dto; const id = await this.generateRoomId(); const socket = this.socketService.getSocket(socketId); const currentTime = Date.now(); const questionList = await this.questionListRepository.findOne({ where: { id: dto.questionListId }, }); const questionListContent = await this.questionRepository.getContentsByQuestionListId( dto.questionListId ); questionList.usage += 1; await this.questionListRepository.save(questionList); const roomDto = { ...dto, id, inProgress: false, connectionMap: {}, participants: 0, questionListContents: questionListContent, createdAt: currentTime, maxQuestionListLength: questionListContent.length, questionListTitle: questionList.title, currentIndex: 0, host: { socketId: dto.socketId, nickname, createAt: currentTime, }, }; await this.roomRepository.setRoom(roomDto); socket.emit(EMIT_EVENT.CREATE, roomDto); } @Transactional() public async createRoom( createRoomDto: CreateRoomDto, socket: Socket ): Promise\u003cCreateRoomResponseDto\u003e { const currentTime = Date.now(); const questionData = await this.useQuestionList(createRoomDto.questionListId); const roomObj = { ...createRoomDto, id: await this.generateRoomId(), inProgress: false, connectionMap: {}, participants: 0, createdAt: currentTime, maxQuestionListLength: questionData.content.length, questionListTitle: questionData.title, currentIndex: 0, host: { socketId: socket.id, nickname: createRoomDto.nickname, createAt: currentTime, }, }; const room = new Room(roomObj).build(); // 바뀐 코드에서는 굳이 엔티티를 변환하는 작업을 구현할 필요 없음 await this.roomRepository.setRoom(room); socket.emit(EMIT_EVENT.CREATE, room); return CreateRoomInternalDto.from(room); // 리턴값을 엄밀히 설정 } 세번째 예시 : 역직렬화 상태를 유동적으로 저장 가능 마지막으로, 받아온 엔티티를 언제든 역직렬화해서 하는 문법에 대한 책임이 분리될 수 있었습니다.\npublic async getPublicRoom(inProgress?: boolean): Promise\u003cRoomListResponseDto[]\u003e { const rooms = await this.roomRepository.getAllRoom(); const filterFunction = (room: RoomEntity) =\u003e room.status === RoomStatus.PUBLIC \u0026\u0026 (inProgress === undefined || room.inProgress === inProgress); return rooms .filter(filterFunction) .sort((a, b) =\u003e b.createdAt - a.createdAt) .map((room) =\u003e Room.fromEntity(room)) .map((room) =\u003e ({ ...room.toObject(), host: room.getHost(), participants: room.getParticipants(), connectionMap: undefined, })); } 심지어 이전 코드에서는 엔티티에 존재하지 않는 정보를 레포지토리에서 가공하여 객체로 제공하고 있었습니다. 이런 부분에서 책임 분리가 확실하게 될 수 있었던 것 같습니다.\npublic async getPublicRoom(inProgress?: boolean): Promise\u003cRoomListResponseDto\u003e { const rooms = await this.roomRepository.getAllRoom(); return rooms .filter( (room) =\u003e room.status === RoomStatus.PUBLIC \u0026\u0026 (inProgress === undefined || room.inProgress === inProgress) ) .sort((a, b) =\u003e b.createdAt - a.createdAt) .map((room) =\u003e ({ createdAt: room.createdAt, host: room.host, maxParticipants: room.maxParticipants, status: room.status, title: room.title, id: room.id, category: room.category, inProgress: room.inProgress, questionListTitle: room.questionListTitle, participants: room.participants, // 엔티티에는 없는 정보를 레포지토리가 가공하고 있었다! })); } 아직 남은 점 Entity 프로퍼티를 public으로 열어두었다. 이렇게 보면, 도메인 객체의 상태가 언제든지 바뀔 수 있다는 위험이 있었습니다.\n해당 부분의 경우 일일이 setter, getter 를 도입하고, entity 객체 자체를 캡슐화하여 해결할 수 있었을 것이라고 생각합니다.\n다만, 현재 리팩토링 대상인 도메인 객체의 프로퍼티 값이 13개 나 되어.. 차라리 구조적으로 개편하고 setter getter 를 적게 설정하는 방향도 좋을 것 같다고 생각이 들었습니다.\n외부 라이브러리를 수정해서 개선해보기 @moozeh/nestjs-redis-om 라이브러리를 제가 직접 포크해온 만큼, 제가 편하게 쓸 수 있도록 개선할 수 있었을 것입니다. 시간과 비용을 생각해서 제가 편하게 쓸 수 없어서 아쉬울 따름입니다..\n참고자료 https://appleg1226.tistory.com/40 문제 해결 과정 2. 클린코드에 대해서 : 어떤게 문제인지 확실히 파악하기 클린코드에 대해서 경계 할 것이 아니라, 어떤게 문제인지 확실히 아는 프로그래머가 되는 게 중요하다고 생각하게된 영상을 보았습니다.\n포프님의 영상에 달린 댓글에 이런 내용이 눈에 들어왔고, 스스로 어떻게 해야 협업할 수 있는 개발자인지 생각해보려고 합니다.\n어떤 업무건 업의 본질이라는 게 있습니다.\n프로그래밍 또한 업의 본질을 이해해야 한다고 생각합니다.\n효율적인 업무 진행을 위한 서로간의 조율이 필요합니다. TDD를 써야하면 그렇게 해야하고, 다른 방법론이 있다면 그것을 적용하고..\n따라서 앞서 제가 진행했던 스터디 세션 부분 리팩토링과 같은 부분은 팀을 위한 조율이 아니라고 생각했습니다. 그 후부터는 최대한 팀의 가치 에 집중했고, 이것이 진정한 본질이 아닐까 한번 생각을 해보게 됐습니다.\n아직 많이 부족하지만, 아래 글에서 처럼, 협업의 가치를 조금씩 깨달아가고 있음을 스스로 느끼고 있습니다.\nJWT 토큰 파싱 변경 과정과 협업의 가치에 대한 고민\n협업을 위한 더러운 코드 200줄이나 되는 코드를 직접 올려보겠습니다.\nimport { Injectable } from \"@nestjs/common\"; import { RoomEntity } from \"@/room/room.entity\"; import { RoomRepository } from \"@/room/room.repository\"; import { RoomListResponseDto } from \"@/room/dto/all-room.dto\"; import { Socket } from \"socket.io\"; import { CreateRoomDto, CreateRoomResponseDto } from \"@/room/dto/create-room.dto\"; import { JoinRoomDto, JoinRoomResponseDto } from \"@/room/dto/join-room.dto\"; import { Transactional } from \"typeorm-transactional\"; import { Room, RoomStatus } from \"@/room/domain/room\"; import { EMIT_EVENT } from \"@/room/room.events\"; import { createHash } from \"node:crypto\"; import { QuestionRepository } from \"@/question-list/repository/question.respository\"; import { FullRoomException, InProgressException } from \"@/room/exceptions/join-room-exceptions\"; import { InfraService } from \"@/infra/infra.service\"; import { QuestionListRepository } from \"@/question-list/repository/question-list.repository\"; @Injectable() export class RoomService { private static ROOM_ID_CREATE_KEY = \"room_id\"; public constructor( private readonly roomRepository: RoomRepository, private readonly infraService: InfraService, private readonly questionListRepository: QuestionListRepository, private readonly questionRepository: QuestionRepository ) {} public async leaveRoom(socket: Socket) { const rooms = await this.infraService.getSocketMetadata(socket); for await (const roomId of rooms.joinedRooms) await this.processRoomLeave(socket.id, roomId); } @Transactional() public async createRoom( createRoomDto: CreateRoomDto, socket: Socket ): Promise\u003cCreateRoomResponseDto\u003e { const currentTime = Date.now(); const questionData = await this.useQuestionList(createRoomDto.questionListId); const roomObj = { ...createRoomDto, id: await this.generateRoomId(), inProgress: false, connectionMap: {}, participants: 0, createdAt: currentTime, maxQuestionListLength: questionData.content.length, questionListTitle: questionData.title, currentIndex: 0, host: { socketId: socket.id, nickname: createRoomDto.nickname, createAt: currentTime, }, }; const room = new Room(roomObj).build(); await this.roomRepository.setRoom(room); socket.emit(EMIT_EVENT.CREATE, room); return { nickname: createRoomDto.nickname, participants: 0, questionListContents: questionData.content, socketId: socket.id, ...roomObj, }; } public async joinRoom(joinRoomDto: JoinRoomDto, socket: Socket): Promise\u003cJoinRoomResponseDto\u003e { const { roomId, nickname } = joinRoomDto; const room = Room.fromEntity(await this.roomRepository.getRoom(roomId)); if (!socket) throw new Error(\"Invalid Socket\"); if (!room.entity) throw new Error(\"RoomEntity Not found\"); await this.infraService.joinRoom(socket, room.entity.id); if (room.entity.inProgress) throw new InProgressException(); if (this.isFullRoom(room)) throw new FullRoomException(); room.addConnection({ socketId: socket.id, createAt: Date.now(), nickname, }); await this.roomRepository.setRoom(room.build()); const questionListContents = await this.questionRepository.getContentsByQuestionListId( room.entity.questionListId ); const obj = room.toObject(); delete obj.connectionMap[socket.id]; return { participants: room.getParticipants(), ...obj, questionListContents, }; } public async getPublicRoom(inProgress?: boolean): Promise\u003cRoomListResponseDto[]\u003e { const rooms = await this.roomRepository.getAllRoom(); const filterFunction = (room: RoomEntity) =\u003e room.status === RoomStatus.PUBLIC \u0026\u0026 (inProgress === undefined || room.inProgress === inProgress); return rooms .filter(filterFunction) .sort((a, b) =\u003e b.createdAt - a.createdAt) .map((room) =\u003e Room.fromEntity(room)) .map((room) =\u003e ({ ...room.toObject(), host: room.getHost(), participants: room.getParticipants(), connectionMap: undefined, })); } public async setProgress(roomId: string, socketId: string, status: boolean) { const room = Room.fromEntity(await this.roomRepository.getRoom(roomId)); if (!room.entity) throw new Error(\"cannot set progress\"); if (room.getHost().socketId !== socketId) throw new Error(\"only host can set process\"); room.entity.inProgress = status; if (!room.entity.inProgress) room.entity.currentIndex = 0; await this.roomRepository.setRoom(room.build()); return status; } public async setIndex(roomId: string, socketId: string, index: number) { const room = Room.fromEntity(await this.roomRepository.getRoom(roomId)); // TODO : 리팩토링 할 필요가 있어보임. if ( !room.entity || !room.entity.inProgress || room.getHost().socketId !== socketId || index \u003c 0 || index \u003e= room.entity.maxQuestionListLength ) return -1; room.entity.currentIndex = index; await this.roomRepository.setRoom(room.build()); return index; } public async getIndex(roomId: string) { return (await this.roomRepository.getRoom(roomId)).currentIndex; } public async increaseIndex(roomId: string, socketId: string) { const room = Room.fromEntity(await this.roomRepository.getRoom(roomId)); if (!room.entity || room.getHost().socketId !== socketId || !room.entity.inProgress) return -1; const index = await this.setIndex(roomId, socketId, (await this.getIndex(roomId)) + 1); if (index === -1) return room.entity.maxQuestionListLength - 1; return index; } public async finishRoom(roomId: string) { await this.roomRepository.removeRoom(roomId); return roomId; } private async processRoomLeave(socketId: string, roomId: string) { const room = Room.fromEntity(await this.roomRepository.getRoom(roomId)); if (!room.entity) return; room.removeConnection(socketId); if (!Object.keys(room.getConnection()).length) return this.deleteRoom(room.entity.id); await this.roomRepository.setRoom(room.build()); if (room.getHost().socketId === socketId) await this.handleHostChange(socketId, room); this.infraService.emitToRoom(roomId, EMIT_EVENT.QUIT, { socketId }); } private async handleHostChange(socketId: string, room: Room) { if (room.getHost().socketId !== socketId) return; const newHost = await this.delegateHost(room); // TODO : throw new Exception : host changed // 에러를 던지는 방식이 아닌 다른 방식으로 해결해야함. this.infraService.emitToRoom(room.entity.id, EMIT_EVENT.CHANGE_HOST, { nickname: newHost.nickname, socketId: newHost.socketId, }); } private async deleteRoom(roomId: string) { await this.roomRepository.removeRoom(roomId); this.infraService.emitToRoom(roomId, EMIT_EVENT.QUIT, { roomId }); } private getNewHost(room: Room) { return Object.values(room.getConnection()).sort((a, b) =\u003e a.createAt - b.createAt)[0]; } private async delegateHost(room: Room) { const newHost = this.getNewHost(room); const found = room.getConnection()[newHost.socketId]; if (!found) throw new Error(\"invalid new host id\"); room.setHost(newHost); await this.roomRepository.setRoom(room.build()); return newHost; } private isFullRoom(room: Room): boolean { return room.entity.maxParticipants \u003c= Object.keys(room.getConnection()).length; } @Transactional() private async useQuestionList(questionListId: number) { const questionData = await this.questionListRepository.findOne({ where: { id: questionListId }, }); const questions = await this.questionRepository.getContentsByQuestionListId(questionListId); questionData.usage += 1; await this.questionListRepository.save(questionData); return { title: questionData.title, content: questions, }; } // TODO: 동시성 고려해봐야하지 않을까? private async generateRoomId() { const client = this.infraService.getRedisClient(); const idString = await client.get(RoomService.ROOM_ID_CREATE_KEY); let id: number; if (idString \u0026\u0026 !isNaN(parseInt(idString))) { id = await client.incr(RoomService.ROOM_ID_CREATE_KEY); } else { id = parseInt(await client.set(RoomService.ROOM_ID_CREATE_KEY, \"1\")); } return createHash(\"sha256\") .update(id + process.env.SESSION_HASH) .digest(\"hex\"); } } 보시기엔 더러울 수 있습니다.\n하지만 인터페이스를 볼까요?\nimport { Injectable } from \"@nestjs/common\"; import { RoomEntity } from \"@/room/room.entity\"; import { RoomRepository } from \"@/room/room.repository\"; import { RoomListResponseDto } from \"@/room/dto/all-room.dto\"; import { Socket } from \"socket.io\"; import { CreateRoomDto, CreateRoomResponseDto } from \"@/room/dto/create-room.dto\"; import { JoinRoomDto, JoinRoomResponseDto } from \"@/room/dto/join-room.dto\"; import { Transactional } from \"typeorm-transactional\"; import { Room, RoomStatus } from \"@/room/domain/room\"; import { EMIT_EVENT } from \"@/room/room.events\"; import { createHash } from \"node:crypto\"; import { QuestionRepository } from \"@/question-list/repository/question.respository\"; import { FullRoomException, InProgressException } from \"@/room/exceptions/join-room-exceptions\"; import { InfraService } from \"@/infra/infra.service\"; import { QuestionListRepository } from \"@/question-list/repository/question-list.repository\"; @Injectable() export class RoomService { private static ROOM_ID_CREATE_KEY = \"room_id\"; public constructor( private readonly roomRepository: RoomRepository, private readonly infraService: InfraService, private readonly questionListRepository: QuestionListRepository, private readonly questionRepository: QuestionRepository ) {} public async leaveRoom(socket: Socket) @Transactional() public async createRoom( createRoomDto: CreateRoomDto, socket: Socket ): Promise\u003cCreateRoomResponseDto\u003e public async joinRoom(joinRoomDto: JoinRoomDto, socket: Socket): Promise\u003cJoinRoomResponseDto\u003e public async getPublicRoom(inProgress?: boolean): Promise\u003cRoomListResponseDto[]\u003e public async finishRoom(roomId: string) public async setProgress(roomId: string, socketId: string, status: boolean) public async setIndex(roomId: string, socketId: string, index: number) public async getIndex(roomId: string) public async increaseIndex(roomId: string, socketId: string) private async processRoomLeave(socketId: string, roomId: string) private async handleHostChange(socketId: string, room: Room) private async deleteRoom(roomId: string) private getNewHost(room: Room) private async delegateHost(room: Room) private isFullRoom(room: Room): boolean @Transactional() private async useQuestionList(questionListId: number) // TODO: 동시성 고려해봐야하지 않을까? private async generateRoomId() } 작업을 위한 private 함수들을 제외하고 보았을 때, 방에 대한 CRUD, 즉 일종의 방에 대한 연산 작업이 한곳에 모여있음을 알 수 있습니다.\n다른 파일에서 해당 클래스의 인터페이스를 확인해보면 생각보다 함수가 별로 없음을 알 수 있습니다.\n핵심 가치 결국에는 중요한 것은 코드의 길이가 아니라 인터페이스 라는 겁니다.. 그렇게 문제를 해결할 수 있었고, 실제로 외부 파일인 핸들러에서 사용할 때 일관되게 사용할 수 있었습니다.\n또한, 한 데에 파일을 모아보니, 오히려 서비스의 수가 줄어서 모듈의 크기가 줄었습니다.\n",
  "wordCount" : "4546",
  "inLanguage": "en",
  "image": "https://blog.blu3fishez.org/images/papermod-cover.png","datePublished": "2024-12-21T12:34:38+09:00",
  "dateModified": "2024-12-21T12:34:38+09:00",
  "author":{
    "@type": "Person",
    "name": "blu3fishez"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.blu3fishez.org/posts/2024/2024-12-21-%ED%98%91%EC%97%85%EC%9D%84-%EC%9C%84%ED%95%9C-%EB%8D%94%EB%9F%AC%EC%9A%B4-%EC%BD%94%EB%93%9C/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "blog.blu3fishez",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.blu3fishez.org/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.blu3fishez.org/" accesskey="h" title="blog.blu3fishez (Alt + H)">blog.blu3fishez</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.blu3fishez.org/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://blog.blu3fishez.org/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://blog.blu3fishez.org/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://blog.blu3fishez.org/">Home</a>&nbsp;»&nbsp;<a href="https://blog.blu3fishez.org/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      협업을 위한 더러운 코드
    </h1>
    <div class="post-meta"><span title='2024-12-21 12:34:38 +0900 KST'>December 21, 2024</span>&nbsp;·&nbsp;22 min&nbsp;·&nbsp;blu3fishez

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%eb%ac%b8%ec%a0%9c-%ec%83%81%ed%99%a9" aria-label="문제 상황">문제 상황</a></li>
                <li>
                    <a href="#%ed%95%b4%ea%b2%b0-%ec%8b%9c%eb%8f%84-%ea%b3%bc%ec%a0%95" aria-label="해결 시도 과정">해결 시도 과정</a><ul>
                        
                <li>
                    <a href="#nestjs-%ec%97%90%ec%84%9c-%ec%9d%98%ec%a1%b4%ec%84%b1%ec%9d%84-%ea%b4%80%eb%a6%ac%ed%95%98%eb%8a%94-%eb%b0%a9%eb%b2%95" aria-label="Nest.js 에서 의존성을 관리하는 방법">Nest.js 에서 의존성을 관리하는 방법</a></li></ul>
                </li>
                <li>
                    <a href="#%eb%a6%ac%ed%8c%a9%ed%86%a0%eb%a7%81%ec%9d%84-%ec%98%ac%eb%b0%94%eb%a5%b4%ea%b2%8c-%ed%95%98%ea%b8%b0-%ec%9c%84%ed%95%9c-%ea%b3%bc%ec%a0%9c" aria-label="리팩토링을 올바르게 하기 위한 과제">리팩토링을 올바르게 하기 위한 과제</a><ul>
                        
                <li>
                    <a href="#%ed%99%95%ec%9e%a5%ec%84%b1%ec%9d%84-%ec%97%bc%eb%91%90%ec%97%90-%eb%91%90%ea%b3%a0-%ec%84%a4%ea%b3%84%ed%95%98%ea%b8%b0" aria-label="확장성을 염두에 두고 설계하기">확장성을 염두에 두고 설계하기</a></li>
                <li>
                    <a href="#%ec%bd%94%eb%93%9c%ec%9d%98-%ec%a4%84-%ec%88%98%ec%97%90-%ec%97%b0%ec%97%b0%ed%95%98%ec%a7%80-%ec%95%8a%ea%b3%a0-%ea%b0%9d%ec%b2%b4%ec%9d%98-%ec%b1%85%ec%9e%84%ec%9d%84-%ec%83%9d%ea%b0%81%ed%95%b4%eb%b3%b4%ea%b8%b0" aria-label="코드의 줄 수에 연연하지 않고, 객체의 책임을 생각해보기">코드의 줄 수에 연연하지 않고, 객체의 책임을 생각해보기</a></li></ul>
                </li>
                <li>
                    <a href="#%eb%ac%b8%ec%a0%9c-%ed%95%b4%ea%b2%b0-%ea%b3%bc%ec%a0%95-1-facade-%ed%8c%a8%ed%84%b4%ec%9c%bc%eb%a1%9c-redis-om-%ec%97%94%ed%8b%b0%ed%8b%b0%ec%97%90-%eb%8f%84%eb%a9%94%ec%9d%b8-%eb%a1%9c%ec%a7%81-%ea%b2%b0%ed%95%a9%ed%95%98%ea%b8%b0" aria-label="문제 해결 과정 1. Facade 패턴으로 redis-om 엔티티에 도메인 로직 결합하기">문제 해결 과정 1. Facade 패턴으로 redis-om 엔티티에 도메인 로직 결합하기</a><ul>
                        
                <li>
                    <a href="#ddd-%ec%9d%98-%ec%a0%95%ec%9d%98" aria-label="DDD 의 정의..?">DDD 의 정의..?</a></li>
                <li>
                    <a href="#%ec%b2%ab%eb%b2%88%ec%a7%b8-%ed%95%b4%ea%b2%b0-%ec%8b%9c%eb%8f%84--redis-om-%ec%97%94%ed%8b%b0%ed%8b%b0%eb%a5%bc-%ec%83%81%ec%86%8d%eb%b0%9b%ea%b8%b0" aria-label="첫번째 해결 시도 : redis-om 엔티티를 상속받기">첫번째 해결 시도 : redis-om 엔티티를 상속받기</a></li>
                <li>
                    <a href="#redis-%ec%97%90%ec%84%9c-%eb%8d%b0%ec%9d%b4%ed%84%b0%eb%a5%bc-%ec%a0%80%ec%9e%a5%ed%95%98%eb%8a%94-%eb%b0%a9%ec%8b%9d" aria-label="Redis 에서 데이터를 저장하는 방식">Redis 에서 데이터를 저장하는 방식</a></li>
                <li>
                    <a href="#%eb%91%90%eb%b2%88%ec%a7%b8-%ed%95%b4%ea%b2%b0-%ec%8b%9c%eb%8f%84--%ec%97%94%ed%8b%b0%ed%8b%b0%ec%99%80-%eb%8f%84%eb%a9%94%ec%9d%b8%ec%9d%84-%eb%84%98%eb%82%98%eb%93%9c%eb%8a%94-%eb%8f%84%eb%a9%94%ec%9d%b8-%ec%84%9c%eb%b9%84%ec%8a%a4" aria-label="두번째 해결 시도 : 엔티티와 도메인을 넘나드는 도메인 서비스">두번째 해결 시도 : 엔티티와 도메인을 넘나드는 도메인 서비스</a></li>
                <li>
                    <a href="#%eb%91%90%eb%b2%88%ec%a7%b8-%ed%95%b4%ea%b2%b0-%ec%8b%9c%eb%8f%84%ec%9d%98-%eb%ac%b8%ec%a0%9c%ec%a0%90" aria-label="두번째 해결 시도의 문제점">두번째 해결 시도의 문제점</a></li>
                <li>
                    <a href="#%ea%b0%80%ec%9e%a5-%ea%b0%84%eb%8b%a8%ed%95%9c-%eb%b0%a9%eb%b2%95%ec%9d%b4-%eb%ac%b4%ec%97%87%ec%9d%bc%ea%b9%8c" aria-label="가장 간단한 방법이 무엇일까?">가장 간단한 방법이 무엇일까?</a></li>
                <li>
                    <a href="#facade-%ed%8c%a8%ed%84%b4%ec%9d%b4%eb%9e%80" aria-label="Facade 패턴이란?">Facade 패턴이란?</a></li>
                <li>
                    <a href="#%ea%b7%b8-%ea%b2%b0%ea%b3%bc-%ec%84%9c%eb%b9%84%ec%8a%a4-%ec%bd%94%eb%93%9c" aria-label="그 결과 서비스 코드">그 결과 서비스 코드</a><ul>
                        
                <li>
                    <a href="#%ec%b2%ab%eb%b2%88%ec%a7%b8-%ec%98%88%ec%8b%9c--%ec%ba%a1%ec%8a%90%ed%99%94%eb%a5%bc-%ed%86%b5%ed%95%9c-%ec%84%9c%eb%b9%84%ec%8a%a4%ec%97%90%ec%84%9c%ec%9d%98-%eb%8f%84%eb%a9%94%ec%9d%b8-%ea%b4%80%ec%8b%ac-%eb%b6%84%eb%a6%ac" aria-label="첫번째 예시 : 캡슐화를 통한 서비스에서의 도메인 관심 분리">첫번째 예시 : 캡슐화를 통한 서비스에서의 도메인 관심 분리</a></li>
                <li>
                    <a href="#%eb%91%90%eb%b2%88%ec%a7%b8-%ec%98%88%ec%8b%9c--%ed%99%95%ec%9e%a5-%ea%b0%80%eb%8a%a5%ed%95%9c-dto-%eb%b3%80%ed%99%98-%eb%a1%9c%ec%a7%81%ec%9d%98-%ec%83%9d%ec%84%b1-%ea%b0%80%eb%8a%a5" aria-label="두번째 예시 : 확장 가능한 DTO 변환 로직의 생성 가능">두번째 예시 : 확장 가능한 DTO 변환 로직의 생성 가능</a></li>
                <li>
                    <a href="#%ec%84%b8%eb%b2%88%ec%a7%b8-%ec%98%88%ec%8b%9c--%ec%97%ad%ec%a7%81%eb%a0%ac%ed%99%94-%ec%83%81%ed%83%9c%eb%a5%bc-%ec%9c%a0%eb%8f%99%ec%a0%81%ec%9c%bc%eb%a1%9c-%ec%a0%80%ec%9e%a5-%ea%b0%80%eb%8a%a5" aria-label="세번째 예시 : 역직렬화 상태를 유동적으로 저장 가능">세번째 예시 : 역직렬화 상태를 유동적으로 저장 가능</a></li></ul>
                </li>
                <li>
                    <a href="#%ec%95%84%ec%a7%81-%eb%82%a8%ec%9d%80-%ec%a0%90" aria-label="아직 남은 점">아직 남은 점</a><ul>
                        
                <li>
                    <a href="#entity-%ed%94%84%eb%a1%9c%ed%8d%bc%ed%8b%b0%eb%a5%bc-public%ec%9c%bc%eb%a1%9c-%ec%97%b4%ec%96%b4%eb%91%90%ec%97%88%eb%8b%a4" aria-label="Entity 프로퍼티를 public으로 열어두었다.">Entity 프로퍼티를 public으로 열어두었다.</a></li>
                <li>
                    <a href="#%ec%99%b8%eb%b6%80-%eb%9d%bc%ec%9d%b4%eb%b8%8c%eb%9f%ac%eb%a6%ac%eb%a5%bc-%ec%88%98%ec%a0%95%ed%95%b4%ec%84%9c-%ea%b0%9c%ec%84%a0%ed%95%b4%eb%b3%b4%ea%b8%b0" aria-label="외부 라이브러리를 수정해서 개선해보기">외부 라이브러리를 수정해서 개선해보기</a></li></ul>
                </li>
                <li>
                    <a href="#%ec%b0%b8%ea%b3%a0%ec%9e%90%eb%a3%8c" aria-label="참고자료">참고자료</a></li></ul>
                </li>
                <li>
                    <a href="#%eb%ac%b8%ec%a0%9c-%ed%95%b4%ea%b2%b0-%ea%b3%bc%ec%a0%95-2-%ed%81%b4%eb%a6%b0%ec%bd%94%eb%93%9c%ec%97%90-%eb%8c%80%ed%95%b4%ec%84%9c--%ec%96%b4%eb%96%a4%ea%b2%8c-%eb%ac%b8%ec%a0%9c%ec%9d%b8%ec%a7%80-%ed%99%95%ec%8b%a4%ed%9e%88-%ed%8c%8c%ec%95%85%ed%95%98%ea%b8%b0" aria-label="문제 해결 과정 2. 클린코드에 대해서 : 어떤게 문제인지 확실히 파악하기">문제 해결 과정 2. 클린코드에 대해서 : 어떤게 문제인지 확실히 파악하기</a><ul>
                        
                <li>
                    <a href="#%ed%98%91%ec%97%85%ec%9d%84-%ec%9c%84%ed%95%9c-%eb%8d%94%eb%9f%ac%ec%9a%b4-%ec%bd%94%eb%93%9c" aria-label="협업을 위한 더러운 코드">협업을 위한 더러운 코드</a></li></ul>
                </li>
                <li>
                    <a href="#%ed%95%b5%ec%8b%ac-%ea%b0%80%ec%b9%98" aria-label="핵심 가치">핵심 가치</a>
                </li>
            </ul>
        </div>
    </details>
</div>
<div class="post-content"><h2 id="문제-상황">문제 상황<a hidden class="anchor" aria-hidden="true" href="#문제-상황">#</a></h2>
<p>스터디 세션을 리팩토링 과정에서 코드가 길어져서 고민을 했었습니다. 특히나 <code>비즈니스 로직과 레포지토리 코드가 혼재</code> 해 있었고, 그 부분에서 하나의 핸들러가 호출하는 로직에서 서비스.. 레포지토리.. 이렇게 다양한 계층을 따라 로직이 퍼져있었습니다.</p>
<p>예를 들면, 레포지토리에서는 데이터 베이스 (혹은 자료 저장소) 에 관해서 어떤 정보가 저장되어 있어야하는지</p>
<p>그래서 해당 부분을 리팩토링을 시도했으나, 오히려 팀의 성장에 방해가 되었습니다. 그 부분에 있어서는 <code>조금 더 깔끔한 코드와 프로토콜을 만들고자 하는 욕심</code> 이 1순위로 작용했던 것이 아닐까 하고 회고하면서 판단해봅니다.</p>
<p>협업의 본질을 잊어버리고 스터디 기능 자체를 1일만에 개발한 건 분명 좋은 발전이었으나, 그만큼 3일을 팀 입장에서는 허비시키게 만들었습니다.</p>
<p>사실 이벤트 명을 바꾼건 크게 문제가 되지 않았습니다. 그냥 바꾸면 되니까요. 그런데 문제는 이런 점이었습니다.</p>
<img src="/assets/images/Pasted%20image%2020241228220445.webp" alt="Pasted image 20241228220445" loading="lazy">
<p>위 내용은 제 리팩토링(이라는 이름의 리워크)에 영향받은, 저희 팀원의 스크럼 내용입니다. 이게 과연 협업일까요..? 이때 스스로 많이 반성하게 되었습니다. <code>스스로 협업을 위한 코드랍시고 나만을 위한 깔끔한 코드를 짜려고 했던 것 같았습니다.</code></p>
<h2 id="해결-시도-과정">해결 시도 과정<a hidden class="anchor" aria-hidden="true" href="#해결-시도-과정">#</a></h2>
<p>결국 잘 모르겠어서 멘토님께 여쭤보았습니다. 부스트캠프에서 주어진 <code>팀 멘토링</code> 시간을 활용하였고, 글로 남겨서 정리하여 멘토님께 질문드려봤습니다. 이때까지만 해도 저는 <code>나만을 위한 깔끔한 코드</code> 에 집착하고 있었고, 이에 아래와 같이 질문하게 되었습니다.</p>
<blockquote>
<p><strong>질문</strong></p>
<p>스터디 세션 부분을 리팩토링하면서 고민을 많이했었습니다.. 아예 구조 자체를 바꿔버리는 스펙이 변경되는 규모에서 100줄 이상 길어지는 코드를 여러 파일로 나누어 관리하다보니 아예 함수 (방을 나가는 로직) 만을 위한 서비스 클래스를 작성하게 되었고, 구별하게 되었는데 결론적으로는 예전보다는 보기가 쉽다고 팀 내부적으로 결론이 났었습니다.</p>
<p>그런데 이게 나중에 가서 최적화 측면에서 문제가 될 지 궁금합니다. 실제로 클래스 기반으로 함수를 짜실 때 멘토님께서는 어떤 방식으로 길어지는 로직을 분리하시거나 관리하시는지 궁금합니다.</p></blockquote>
<blockquote>
<p><strong>멘토님의 답변</strong></p>
<p>가독성은 사실 주관적인 것입니다. 그래서 저는 클래스 기반으로 함수를 짜는 것은 개인적으로 추천하지 않습니다. 보통 재사용성이 높은 코드를 분리하는게 가독성이 좋다고 합니다. 그렇다고 두세번 쓰인다고 무조건 분리하는 것은 추천하지 않습니다.</p>
<p>보통 코드의 줄수를 줄이기만을 위해 고치려고 하지는 않습니다. 코드가 길어져도 분명한 역할이 있다면 그대로 두는게 맞다고 생각합니다. 많이 쓰이는 오픈소스 라이브러리들 중에서도 한 파일에 천 줄이 넘는 코드가 많습니다. 물론 구조화가 잘 되어서 나눠지면 좋지만, 그럴 수 없는 경우도 많으며 이때 코드가 길기 때문에 분리해야한다!는 곤란하다고 생각합니다. 오히려 한 파일에 긴 코드가 있는게 더 가독성이 높을 때도 많습니다. 코드의 길이보다도 구조에 중점을 두는게 더 좋을 때도 있습니다. 그러니, 확장 가능성을 고려해서 구조화를 하고, 분리를 해보세요</p></blockquote>
<p>멘토님께서는 실제로 클린코드와 같은 개념에 대해 의식하고 계신 것 같았습니다. 저도 실제로 클린 코드의 위험성에 대해 인지는 하고 있었지만, 멘토님께서는 많이 우려스러운 답변을 주셔서 저도 속으로는 의아했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.repository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@nestjs/common&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Injectable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RoomHostService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">roomRepository</span>: <span class="kt">RoomRepository</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getNewHost</span><span class="p">(</span><span class="nx">room</span>: <span class="kt">RoomDto</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span><span class="p">).</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">createAt</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createAt</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">delegateHost</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;Invalid room Id&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">newHost</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getNewHost</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span><span class="p">[</span><span class="nx">newHost</span><span class="p">.</span><span class="nx">socketId</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;invalid new host id&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">newHost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">newHost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>위 방식도 Nest.js</code> 에서 각각의 의존성이 어떻게 관리되고 있는지 생각해봐야합니다.</p>
<h3 id="nestjs-에서-의존성을-관리하는-방법">Nest.js 에서 의존성을 관리하는 방법<a hidden class="anchor" aria-hidden="true" href="#nestjs-에서-의존성을-관리하는-방법">#</a></h3>
<p>기본적으로 <code>Nest.js</code> 에서는 의존성을 하나의 인스턴스(싱글턴 객체)로 생성하여 관리하고 있습니다. 그렇게 될 경우, 서비스를 마구잡이로 나눌 경우, 제아무리 싱글턴 객체라도 메모리를 차지하는 것은 어쩔 수 없는 사실입니다.</p>
<p>물론, 멘토님께서도 완벽히 위와같은 코드를 분리하는 것에 반대를 하지 않으셨고, <strong>애매한 상황이라고 말씀해주시긴 하셨습니다.</strong> <strong><code>무엇이든 정답이 없습니다.</code></strong> 하나의 방법이 정답이라고 생각했던 것이 잘못되었다고 생각했습니다. 이번 케이스에서는 프론트엔드 개발자분의 스펙 변경에 대해서 고려하지 않고, 단순히 <strong><code>코드의 가독성만을 위해서 구조를 나눈 것이 주객전도됨을 깨달았습니다.</code></strong></p>
<p>특히나, 확장성을 고려하여 <code>roomService</code> 의 인터페이스를 맞추지 않았어서 문제가 되었습니다. 실제로 이렇게 <code>편하게 보기위해</code> 코드를 짰을 경우, 외부 모듈에서 참조를 하게 되는 경우 <code>roomService</code>가 아니라 <code>roomHostService</code>를 불러와야하는지 어떤걸 불러와야 적용할 수 있는지 확인할 수 없었습니다. 처음 적용할 때 <code>roomService</code> 에 없는 것을 보고 <code>엥?</code> 싶을 것이다 생각이 들었습니다.</p>
<p>특히나 리턴되는 값을 마구잡이로 바꿔가면서 <code>테스트 코드</code>의 중요성을 깨닫게 되었습니다. 리팩토링을 할 때 테스트 코드를 통해 스펙을 고정하고 리팩토링을 하게 되어야함을 깨달았습니다.</p>
<p>코드가 500줄이 되던 400줄이 되던, 실제 오픈 소스 코드는 1000줄이 되더라도, <code>특정 클래스가 수행하는 역할을 잘 수행한다면 상관없다</code>라는 부분에서 깨달음을 얻었습니다. 확실히, 방을 생성하는 것만 <code>roomService</code> 가 아닌, <code>roomCreateService</code> 에서 불러오는 게 확실히 이상하다고 생각이 들었습니다.</p>
<h2 id="리팩토링을-올바르게-하기-위한-과제">리팩토링을 올바르게 하기 위한 과제<a hidden class="anchor" aria-hidden="true" href="#리팩토링을-올바르게-하기-위한-과제">#</a></h2>
<h3 id="확장성을-염두에-두고-설계하기">확장성을 염두에 두고 설계하기<a hidden class="anchor" aria-hidden="true" href="#확장성을-염두에-두고-설계하기">#</a></h3>
<p>사실 제가 생각하기에 서비스를 나눌 때 과하게 나누었다고 생각은 들었습니다.</p>
<img src="/assets/images/Pasted%20image%2020241228220621.webp" alt="Pasted image 20241228220621" loading="lazy">
<p>현재 제가 리팩토링한 서비스들을 폴더로 depth를 두어, 각각의 기능은 각각의 서비스에서 하는 식으로 함수 하나가 길어지는 경우를 나누어서 관리하기 편하도록 만들었습니다. 그리고, 아래 코드는 실제 <code>room-create.service.ts</code> 코드입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@nestjs/common&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">CreateRoomInternalDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/create-room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">EMIT_EVENT</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.events&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">WebsocketService</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/websocket/websocket.service&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.repository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">QuestionListRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/question-list/question-list.repository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomJoinService</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/services/room-join.service&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">createHash</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;node:crypto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="s2">&#34;dotenv/config&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Injectable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RoomCreateService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">ROOM_ID_CREATE_KEY</span> <span class="o">=</span> <span class="s2">&#34;room_id&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">roomRepository</span>: <span class="kt">RoomRepository</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">socketService</span>: <span class="kt">WebsocketService</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">questionListRepository</span>: <span class="kt">QuestionListRepository</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">roomJoinService</span>: <span class="kt">RoomJoinService</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">createRoom</span><span class="p">(</span><span class="nx">dto</span>: <span class="kt">CreateRoomInternalDto</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">socketId</span><span class="p">,</span> <span class="nx">nickname</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">generateRoomId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">socketService</span><span class="p">.</span><span class="nx">getSocket</span><span class="p">(</span><span class="nx">socketId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">questionListContents</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionListRepository</span><span class="p">.</span><span class="nx">getContentsByQuestionListId</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">dto</span><span class="p">.</span><span class="nx">questionListId</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">roomDto</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span><span class="nx">dto</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inProgress</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">connectionMap</span><span class="o">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListContents</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createdAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">socketId</span>: <span class="kt">dto.socketId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">createAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">roomDto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">EMIT_EVENT</span><span class="p">.</span><span class="nx">CREATE</span><span class="p">,</span> <span class="nx">roomDto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: 동시성 고려해봐야하지 않을까?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">generateRoomId() {</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">socketService</span><span class="p">.</span><span class="nx">getRedisClient</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">idString</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">RoomCreateService</span><span class="p">.</span><span class="nx">ROOM_ID_CREATE_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">id</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">idString</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">idString</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="nx">RoomCreateService</span><span class="p">.</span><span class="nx">ROOM_ID_CREATE_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">RoomCreateService</span><span class="p">.</span><span class="nx">ROOM_ID_CREATE_KEY</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="s2">&#34;sha256&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SESSION_HASH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&#34;base64url&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="코드의-줄-수에-연연하지-않고-객체의-책임을-생각해보기">코드의 줄 수에 연연하지 않고, 객체의 책임을 생각해보기<a hidden class="anchor" aria-hidden="true" href="#코드의-줄-수에-연연하지-않고-객체의-책임을-생각해보기">#</a></h3>
<p>코드의 줄 수가 많으면 읽기 힘드신 분이 많으신가요, 아니면 코드가 길어도 인터페이스만 깔끔하면 선호하시나요? 저는 저만의 방법을 많이 생각을 많이했고, 특히 <code>DTO</code> 와 <code>엔티티</code> 의 형태가 조잡하게 변환이 되고 있었음을 깨달았습니다. 그래서 형태를 일관적으로 유지하는 것에 대해서 신경쓰는게 중요하다는 것을 파악했습니다.</p>
<p>일단 첫번째로, <code>API</code> 의 입출력 형태를 맞추기 위한 DTO를 설정했습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ArrayMaxSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ArrayMinSize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">IsArray</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">IsEnum</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">IsNotEmpty</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">IsNumber</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Max</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Min</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;class-validator&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Connection</span><span class="p">,</span> <span class="nx">RoomStatus</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/domain/room&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Question</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/question-list/entity/question.entity&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">CreateRoomDto</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">MAX_CATEGORY_SIZE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">MIN_CATEGORY_SIZE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">MAX_PARTICIPANT_SIZE</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">MIN_PARTICIPANT_SIZE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">@IsNotEmpty</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@IsEnum</span><span class="p">(</span><span class="nx">RoomStatus</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">message</span><span class="o">:</span> <span class="s2">&#34;Status must be either PUBLIC or PRIVATE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span>: <span class="kt">RoomStatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@IsNotEmpty</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nickname</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@IsNotEmpty</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">@IsArray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">@ArrayMaxSize</span><span class="p">(</span><span class="nx">CreateRoomDto</span><span class="p">.</span><span class="nx">MAX_CATEGORY_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">@ArrayMinSize</span><span class="p">(</span><span class="nx">CreateRoomDto</span><span class="p">.</span><span class="nx">MIN_CATEGORY_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">category</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@IsNumber</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">@Min</span><span class="p">(</span><span class="nx">CreateRoomDto</span><span class="p">.</span><span class="nx">MIN_PARTICIPANT_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">@Max</span><span class="p">(</span><span class="nx">CreateRoomDto</span><span class="p">.</span><span class="nx">MAX_PARTICIPANT_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxParticipants</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@IsNumber</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">questionListId</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">CreateRoomResponseDto</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span>: <span class="kt">RoomStatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nickname</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxParticipants</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">category</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">questionListId</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inProgress</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">connectionMap</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">Connection</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">participants</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">questionListContents</span>: <span class="kt">Question</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createdAt</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">host</span>: <span class="kt">Connection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>이렇게 반환 값을 정해버리는 순간, 리팩토링을 하면서 <code>API</code>를 변경할 일이 없어졌습니다. 어쨌거나 타입스크립트 컴파일러 단에서 잡아주니까, 보다 안정적으로 리팩토링할 수 있었습니다.</p>
<p>두번째로, 이런 DTO들을 통해 레포지토리에 연관되고 있음을 깨달았습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@nestjs/common&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">InjectRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@moozeh/nestjs-redis-om&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Repository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;redis-om&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomEntity</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.entity&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Injectable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RoomRepository</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kd">@InjectRepository</span><span class="p">(</span><span class="nx">RoomEntity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">roomRepository</span>: <span class="kt">Repository</span><span class="p">&lt;</span><span class="nt">RoomEntity</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO : .from 메서드 구현 필요?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getAllRoom</span><span class="p">()</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomDto</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">allRooms</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">().</span><span class="k">return</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">allRooms</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">room</span>: <span class="kt">RoomEntity</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">connectionMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">||</span> <span class="s2">&#34;{}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">connectionMap</span>: <span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">||</span> <span class="s2">&#34;{}&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">createdAt</span>: <span class="kt">room.createdAt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">host</span>: <span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">host</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">maxParticipants</span>: <span class="kt">room.maxParticipants</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">maxQuestionListLength</span>: <span class="kt">room.maxQuestionListLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">questionListId</span>: <span class="kt">room.questionListId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">questionListTitle</span>: <span class="kt">room.questionListTitle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">currentIndex</span>: <span class="kt">room.currentIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">status</span>: <span class="kt">room.status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">title</span>: <span class="kt">room.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">id</span>: <span class="kt">room.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">category</span>: <span class="kt">room.category</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">inProgress</span>: <span class="kt">room.inProgress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">participants</span>: <span class="kt">Object.keys</span><span class="p">(</span><span class="nx">connectionMap</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getRoom</span><span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomDto</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="k">return</span><span class="p">.</span><span class="nx">first</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">connectionMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">||</span> <span class="s2">&#34;{}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">category</span>: <span class="kt">room.category</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inProgress</span>: <span class="kt">room.inProgress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">connectionMap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createdAt</span>: <span class="kt">room.createdAt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">currentIndex</span>: <span class="kt">room.currentIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxQuestionListLength</span>: <span class="kt">room.maxQuestionListLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListId</span>: <span class="kt">room.questionListId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListTitle</span>: <span class="kt">room.questionListTitle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span>: <span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">host</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">Object.keys</span><span class="p">(</span><span class="nx">connectionMap</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxParticipants</span>: <span class="kt">room.maxParticipants</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">status</span>: <span class="kt">room.status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span>: <span class="kt">room.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span>: <span class="kt">room.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">setRoom</span><span class="p">(</span><span class="nx">dto</span>: <span class="kt">RoomDto</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RoomEntity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">category</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">dto</span><span class="p">.</span><span class="nx">connectionMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">maxParticipants</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">maxParticipants</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">maxQuestionListLength</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">maxQuestionListLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">questionListId</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">questionListId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">questionListTitle</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">questionListTitle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">dto</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">removeRoom</span><span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">entities</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="k">return</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">entity</span> <span class="k">of</span> <span class="nx">entities</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>보시면 <code>redis-om</code>  으로 인해 객체의 직렬화를 일일이 해주고 있었습니다. <code>레포지토리는 순전히 엔티티를 반영하고 가져오기만을 해야한다고 생각했습니다.</code> 그것이 명확한 책임의 경계선이라고 생각했고, 각자의 도메인마다 필요한 객체의 직렬화가 필요한 프로퍼티를 어떻게 할지 기술적으로 어려움에 직면했습니다.</p>
<h2 id="문제-해결-과정-1-facade-패턴으로-redis-om-엔티티에-도메인-로직-결합하기">문제 해결 과정 1. Facade 패턴으로 redis-om 엔티티에 도메인 로직 결합하기<a hidden class="anchor" aria-hidden="true" href="#문제-해결-과정-1-facade-패턴으로-redis-om-엔티티에-도메인-로직-결합하기">#</a></h2>
<p>확장성 있는 설계를 하라는 멘토님의 말씀을 듣고 고민을 하게 되었습니다. 그래서 현재 제가 리팩토링했던 세션 백엔드 코드 부분(<code>room</code>)에서 어떤 문제가 있는지 고민해본 결과, 현재 <code>redis entity</code> 로 매번 변환 과정을 거치고, 서비스나 레포지토리에서 형변환을 하여 엔티티에 넣는게 과연 맞는지 의문이 들었습니다.</p>
<p>이후 최근에 다른 부캠에서 수료한 친구와 논의도 해보며 <code>Claude</code> 로도 검색을 해서 찾아보았고, 그 과정에서 <code>DDD</code> 라는 용어가 있음을 알게 됐고, 당연히 앞서 언급된 클린코드처럼 해당 개발방법론에 대해서도 주의할 필요가 있었습니다.</p>
<h3 id="ddd-의-정의">DDD 의 정의..?<a hidden class="anchor" aria-hidden="true" href="#ddd-의-정의">#</a></h3>
<blockquote>
<p>⚠ DDD를 적용했다는 의미가 아닙니다.</p>
<p>사실 넓은 의미에서 DDD가 어떤건지도 잘 모를 뿐더러, 지금 적용하기에는 시간이 많이 부족하다고 생각이 들었습니다. 정의 자체에 대한 내용은 많이 나와있습니다. 간략하게 얘기하면, DDD는 복잡한 소프트웨어를 개발할 때 비즈니스 도메인을 중심으로 설계하고 개발하는 방법론입니다.</p></blockquote>
<p><strong>저는 DDD가 제공하는 모든 개념을 사용하진 않았고, 단지 <code>비즈니스 도메인의 역할에 집중하자</code> 라는 문장 한마디로 시작했습니다.</strong></p>
<p>여태까지 서비스, 컨트롤러 등 데이터보다는 사실 <code>로직</code>에 중심을 두었습니다.  모델의 경우도 단순 <code>interface</code> 로 두고 이 객체의 실제 세상에서의 <code>역할</code> 보다, 그저 컴퓨터 세상에서의 <code>자료형</code> 에 집중했던 것 같습니다.</p>
<p>DDD 라는 개념을 도입하면서 또 클린 코드에 집착하는 것 아니냐 할 수 있겠습니다. 하지만 DDD에서 나온 <strong>도메인 로직에 대한 관심분리는 현재 제 프로젝트에 있어서 필요하다고 판단을 했습니다.</strong> 또한, 실제로 프론트엔드에서 변경요청이 잦기도 하고, 앞서 겪었던 스펙 변경에 따른 변경과 소통의 혼선이 잦았습니다.</p>
<p>특히나, DTO 를 <strong>변환하는 로직이 중복</strong>되고 있음을 확인했고, <strong>객체의 형변환이나 검증 로직이 자주 사용되거나, 역할의 책임이 결합</strong>되어있으므로 분리되어야함을 깨달았습니다.</p>
<p>이때 다만 실제로 DDD를 적용하지 않고, 마냥 받아들이는 것이 좋지 않다는 경험을 이전에 클린코드와 관련해 멘토님과 논의해봤던 것을 다시 회상하였고, DDD 에서 쓰이는 개념을 가져오기로 했습니다.</p>
<h3 id="첫번째-해결-시도--redis-om-엔티티를-상속받기">첫번째 해결 시도 : <code>redis-om</code> 엔티티를 상속받기<a hidden class="anchor" aria-hidden="true" href="#첫번째-해결-시도--redis-om-엔티티를-상속받기">#</a></h3>
<p>첫번째 시도는 바로 현재 사용중인 <code>redis-om</code> 에 접근 제한자와 <code>setter,getter</code> 를 넣자는 생각이었습니다. 저는 여태까지 모델에 로직을 넣으면 안돼! 라는 틀에 박힌 생각을 해왔었습니다만, 이번엔 그냥 제가 편하고 관리가 편하면 되지라는 마인드로 도전해보았습니다.</p>
<p>하지만 이때 첫번째 문제가 생겼습니다. 바로 <code>nestjs-edis-om</code> 라는 외부라이브러리에서 <code>Schema</code> 에서는 함수 프로퍼티를 무시해서 보내주지 않았습니다.</p>
<img src="/assets/images/Pasted%20image%2020241230161928.webp" alt="Pasted image 20241230161928" loading="lazy">
_redisom 어댑터를 쓰기엔 기능 확장이 부족했다.._
<p>해당 라이브러리인 <code>nestjs-redis-om</code> 라이브러리를 직접 고치기 위해 제가 포크도 하였지만, 시간과 비용이 많이 발생할 것이라고 예측했습니다.</p>
<h3 id="redis-에서-데이터를-저장하는-방식">Redis 에서 데이터를 저장하는 방식<a hidden class="anchor" aria-hidden="true" href="#redis-에서-데이터를-저장하는-방식">#</a></h3>
<p><code>Redis</code> 에서 데이터를 저장할 때, 객체를 저장할 수 있습니다. 하지만, 각 객체의 프로퍼티는 <code>직렬화</code>가 필수인데요.</p>
<img src="/assets/images/Pasted%20image%2020241230162006.webp" alt="Pasted image 20241230162006" loading="lazy">
<img src="/assets/images/Pasted%20image%2020241230162020.webp" alt="Pasted image 20241230162020" loading="lazy">
<p>실제로 저는 복잡한 객체를 바로바로 제공할 수 있도록 하려고 했고, 연결 정보 자체에 대한 메타데이터들을 <code>room</code> 객체 하위에 <code>connectionMap</code> 이라는 JSON 객체로 저장하고 있습니다.</p>
<p>사실 지금 보면 이를 별도의 도메인으로 만들어 따로 저장해야한다고 생각합니다. 하지만 결국, 이를 따로 키로써 저장하게 되면 키를 조회를 많이 하게 됩니다. <code>싱글스레드</code>인 레디스에서는 최대한 키를 검색하는 과정을 줄여야한다고 생각했습니다.</p>
<p>그렇기에 결국 키를 하나로 저장하려면 직렬화는 필수였습니다. 그래서 이를 위해서는 해당 <code>room</code> 객체의 직렬화 와 역직렬화만을 위한 별도의 로직 함수들이 자주 사용될 것이라고 생각했습니다.</p>
<p>그래서 이렇게 자주 사용되는 도메인 로직을 직접 분리해보기로 했고, 이게 진정한 확장성 있는 설계라고 생각이 들었습니다.</p>
<h3 id="두번째-해결-시도--엔티티와-도메인을-넘나드는-도메인-서비스">두번째 해결 시도 : 엔티티와 도메인을 넘나드는 도메인 서비스<a hidden class="anchor" aria-hidden="true" href="#두번째-해결-시도--엔티티와-도메인을-넘나드는-도메인-서비스">#</a></h3>
<p>그러면 일단 가장 간단하게 <code>자주 사용되는 로직</code>을 분리하는 방법은 뭘까요? 그것은 바로 도메인 로직만을 담은 <code>roomDomainService</code> 를 만드는 방법입니다.</p>
<p>이 방법도 괜찮은 방법이라고 생각했습니다. 아래와 같은 <code>repository</code> 코드를 보면, 실제로 직렬화와 역직렬화를 같이 맡고 있어서 자주 사용되고 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@nestjs/common&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">InjectRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@moozeh/nestjs-redis-om&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Repository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;redis-om&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomEntity</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.entity&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Injectable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RoomRepository</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kd">@InjectRepository</span><span class="p">(</span><span class="nx">RoomEntity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">roomRepository</span>: <span class="kt">Repository</span><span class="p">&lt;</span><span class="nt">RoomEntity</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO : .from 메서드 구현 필요?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getAllRoom</span><span class="p">()</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomDto</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">allRooms</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">().</span><span class="k">return</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">allRooms</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">room</span>: <span class="kt">RoomEntity</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">const</span> <span class="nx">connectionMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">||</span> <span class="s2">&#34;{}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">connectionMap</span>: <span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">||</span> <span class="s2">&#34;{}&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">createdAt</span>: <span class="kt">room.createdAt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">host</span>: <span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">host</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">maxParticipants</span>: <span class="kt">room.maxParticipants</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">maxQuestionListLength</span>: <span class="kt">room.maxQuestionListLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">questionListId</span>: <span class="kt">room.questionListId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">questionListTitle</span>: <span class="kt">room.questionListTitle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">currentIndex</span>: <span class="kt">room.currentIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">status</span>: <span class="kt">room.status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">title</span>: <span class="kt">room.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">id</span>: <span class="kt">room.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">category</span>: <span class="kt">room.category</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">inProgress</span>: <span class="kt">room.inProgress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">participants</span>: <span class="kt">Object.keys</span><span class="p">(</span><span class="nx">connectionMap</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getRoom</span><span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomDto</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">).</span><span class="nx">eq</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="k">return</span><span class="p">.</span><span class="nx">first</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">connectionMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">||</span> <span class="s2">&#34;{}&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">category</span>: <span class="kt">room.category</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inProgress</span>: <span class="kt">room.inProgress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">connectionMap</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createdAt</span>: <span class="kt">room.createdAt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">currentIndex</span>: <span class="kt">room.currentIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxQuestionListLength</span>: <span class="kt">room.maxQuestionListLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListId</span>: <span class="kt">room.questionListId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListTitle</span>: <span class="kt">room.questionListTitle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span>: <span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">host</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">Object.keys</span><span class="p">(</span><span class="nx">connectionMap</span><span class="p">).</span><span class="nx">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxParticipants</span>: <span class="kt">room.maxParticipants</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">status</span>: <span class="kt">room.status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span>: <span class="kt">room.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span>: <span class="kt">room.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">setRoom</span><span class="p">(</span><span class="nx">dto</span>: <span class="kt">RoomDto</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RoomEntity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">category</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">dto</span><span class="p">.</span><span class="nx">connectionMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">maxParticipants</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">maxParticipants</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">maxQuestionListLength</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">maxQuestionListLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">questionListId</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">questionListId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">questionListTitle</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">.</span><span class="nx">questionListTitle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">dto</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">removeRoom</span><span class="p">(</span><span class="nx">id</span>: <span class="kt">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">void</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">entities</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">search</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s2">&#34;id&#34;</span><span class="p">).</span><span class="nx">equals</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="k">return</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">entity</span> <span class="k">of</span> <span class="nx">entities</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p><strong>하지만 이런 상황을 생각해봅시다.</strong></p></blockquote>
<p>가장 간단한 방법이라곤 해도, 매번 <code>엔티티의 상태</code> 를 업데이트해서 넘겨주는게 불편하다고 생각했습니다. 또한, <code>포함관계</code> 가 명확하지 않아서, 어쩔 때는 <code>entity</code> 만을 가지고 모든 걸 수행해야한다는 것에서 통일성이 없을 것 같다고 생각이 들었습니다.</p>
<h3 id="두번째-해결-시도의-문제점">두번째 해결 시도의 문제점<a hidden class="anchor" aria-hidden="true" href="#두번째-해결-시도의-문제점">#</a></h3>
<p>가장 무엇보다 명확한 문제는 <code>역직렬화</code>를 한번만 해서 정보를 가지고 있고, <strong>필요할 때 <code>직렬화</code>를 하게 해주는 작업을 위한 메소드를 사용할 때 매번 엔티티를 필요로 하기 때문에 역직렬화 상태를 저장할 수 없다</strong>는 점입니다.</p>
<p>이를 생각하게 되면, 역직렬화 상태와 직렬화 상태의 객체를 동시에 가지고 다루어야한다는 문제가 생깁니다. 이렇게 되면 헷갈리게 되어 생산성에 방해가 되었습니다.</p>
<p>예를 들면, <strong>RoomEntity</strong> 객체와 <strong>RoomDomain</strong> 객체를 매번 순환하여 저장하는 식으로 변수에 저장하게 되는 상황인 것이죠. 이렇게 되면 실제로 기능 확장 시 <code>RoomDomain</code> 을 쓸 지, <code>RoomEntity</code> 를 쓸 지 헷갈리게 됩니다.</p>
<p>의존성에 관한 문제도 있을 것입니다. <code>Room</code> 도메인이 사용되는 상황에서는 매번 <code>RoomService</code> 가 따라오겠지요. 하지만 이는 <code>Nest</code> 생태계에서의 의존성 관리 덕분에 큰 문제는 아니라고 판단했습니다.</p>
<h3 id="가장-간단한-방법이-무엇일까">가장 간단한 방법이 무엇일까?<a hidden class="anchor" aria-hidden="true" href="#가장-간단한-방법이-무엇일까">#</a></h3>
<p>이전에는 가장 <code>깔끔한</code> 방법을 찾았지만, 이제는 <code>가장 손이 안가는 방법</code> 을 찾는 데에 집중하게 되었습니다. 결국 제가 생각해본 도메인 로직 코드는 아래와 같았습니다.</p>
<p>그리고, 가장 하고 싶었던 건 <code>도메인(단순 할당 등)의 작업 단위</code> 를 한 데 묶고 싶었고, 경우에 따라 로직으로 처리해야할 것은 로직으로 처리하고 싶었습니다.</p>
<p>실제로 위 코드의 <code>Repository</code> 코드에서 수행하던 변환 로직을 이쪽에서 수행하여, 매번 역직렬화 과정을 거치지 않도록 만들었습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomEntity</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.entity&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">Connection</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nickname</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createAt</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">enum</span> <span class="nx">RoomStatus</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">PUBLIC</span> <span class="o">=</span> <span class="s2">&#34;PUBLIC&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">PRIVATE</span> <span class="o">=</span> <span class="s2">&#34;PRIVATE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">IRoom</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">title</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">category</span>: <span class="kt">string</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inProgress</span>: <span class="kt">boolean</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">currentIndex</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">host</span>: <span class="kt">Connection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span>: <span class="kt">RoomStatus</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxParticipants</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxQuestionListLength</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">questionListId</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">questionListTitle</span>: <span class="kt">string</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createdAt</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">connectionMap</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">Connection</span><span class="p">&gt;;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">Room</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="nx">entity</span>: <span class="kt">RoomEntity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">constructor</span><span class="p">(</span><span class="nx">entity?</span>: <span class="kt">IRoom</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">entity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">entity</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RoomEntity</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">setConnection</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">connectionMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">title</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">questionListId</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">questionListId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">questionListTitle</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">questionListTitle</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">maxParticipants</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">maxParticipants</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">category</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">category</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">maxQuestionListLength</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">maxQuestionListLength</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">entity</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">static</span> <span class="nx">fromEntity</span><span class="p">(</span><span class="nx">entity</span>: <span class="kt">RoomEntity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Room</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span> <span class="o">=</span> <span class="nx">entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">room</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">build() {</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">toObject</span><span class="p">()</span><span class="o">:</span> <span class="nx">IRoom</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span>: <span class="kt">this.entity.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">status</span>: <span class="kt">this.entity.status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">connectionMap</span>: <span class="kt">this.getConnection</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span>: <span class="kt">this.entity.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createdAt</span>: <span class="kt">this.entity.createdAt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListId</span>: <span class="kt">this.entity.questionListId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListTitle</span>: <span class="kt">this.entity.questionListTitle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inProgress</span>: <span class="kt">this.entity.inProgress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxParticipants</span>: <span class="kt">this.entity.maxParticipants</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">currentIndex</span>: <span class="kt">this.entity.currentIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">category</span>: <span class="kt">this.entity.category</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxQuestionListLength</span>: <span class="kt">this.entity.maxQuestionListLength</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span>: <span class="kt">this.getHost</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">setHost</span><span class="p">(</span><span class="nx">connection</span>: <span class="kt">Connection</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">connection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">getHost</span><span class="p">()</span><span class="o">:</span> <span class="nx">Connection</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">host</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">setConnection</span><span class="p">(</span><span class="nx">connectionMap</span>: <span class="kt">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">Connection</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">connectionMap</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">connectionMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">getConnection</span><span class="p">()</span><span class="o">:</span> <span class="nx">Record</span><span class="p">&lt;</span><span class="nt">string</span><span class="p">,</span> <span class="na">Connection</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">connectionMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">getParticipants</span><span class="p">()</span><span class="o">:</span> <span class="kt">number</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">()).</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">addConnection</span><span class="p">(</span><span class="nx">connection</span>: <span class="kt">Connection</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">connectionMap</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nx">connectionMap</span><span class="p">[</span><span class="nx">connection</span><span class="p">.</span><span class="nx">socketId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">connection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">setConnection</span><span class="p">(</span><span class="nx">connectionMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">removeConnection</span><span class="p">(</span><span class="nx">socketId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">connectionMap</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">delete</span> <span class="nx">connectionMap</span><span class="p">[</span><span class="nx">socketId</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">setConnection</span><span class="p">(</span><span class="nx">connectionMap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>촉박한 시간관계상 직렬화 역직렬화 등의 필수적인 도메인 로직만을 구현했고, 엔티티를 캡슐화를 일부러 풀어서 다른 프로퍼티의 경우 <code>getter</code> <code>setter</code> 구현 없이 직접 접근하도록 만들었습니다. 이렇게 리팩토링했을 경우 부캠이 끝나고 천천히 리팩토링할 때 도메인 클래스로 마이그레이션 하기 쉽다고 판단했습니다.</p>
<p>그리고 알고보니, 해당 구현 방식은 실제로 존재하는 디자인 패턴이었고, <strong><code>Facade</code> 디자인 패턴을 제가 완전히 활용하고 있었습니다!</strong></p>
<h3 id="facade-패턴이란">Facade 패턴이란?<a hidden class="anchor" aria-hidden="true" href="#facade-패턴이란">#</a></h3>
<p><code>Facade</code> 디자인 패턴이란 복잡한 서브 시스템에 대한 간단한 인터페이스를 제공하는 구조적 디자인 패턴입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="err">#</span> <span class="err">복잡한</span> <span class="err">서브시스템</span> <span class="err">클래스들</span>
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">CPU</span>:
</span></span><span class="line"><span class="cl">    <span class="kt">def</span> <span class="nx">freeze</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">        <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;CPU 동결&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">def</span> <span class="nx">execute</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">        <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;CPU 실행&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">Memory</span>:
</span></span><span class="line"><span class="cl">    <span class="kt">def</span> <span class="nx">load</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">        <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;메모리 로드&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">HardDrive</span>:
</span></span><span class="line"><span class="cl">    <span class="kt">def</span> <span class="nx">read</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span> 
</span></span><span class="line"><span class="cl">        <span class="nx">print</span><span class="p">(</span><span class="s2">&#34;하드드라이브 읽기&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="nx">Facade</span> <span class="err">클래스</span>
</span></span><span class="line"><span class="cl"><span class="kr">class</span> <span class="nx">ComputerFacade</span>:
</span></span><span class="line"><span class="cl">    <span class="kt">def</span> <span class="nx">__init__</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="p">.</span><span class="nx">cpu</span> <span class="o">=</span> <span class="nx">CPU</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="p">.</span><span class="nx">memory</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="p">.</span><span class="nx">hard_drive</span> <span class="o">=</span> <span class="nx">HardDrive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">def</span> <span class="nx">start</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="err">#</span> <span class="err">복잡한</span> <span class="err">시작</span> <span class="err">과정을</span> <span class="err">단순화</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="p">.</span><span class="nx">cpu</span><span class="p">.</span><span class="nx">freeze</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="p">.</span><span class="nx">memory</span><span class="p">.</span><span class="nx">load</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="p">.</span><span class="nx">hard_drive</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">self</span><span class="p">.</span><span class="nx">cpu</span><span class="p">.</span><span class="nx">execute</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">#</span> <span class="err">클라이언트</span> <span class="err">코드</span>
</span></span><span class="line"><span class="cl"><span class="nx">computer</span> <span class="o">=</span> <span class="nx">ComputerFacade</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">computer</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>  <span class="err">#</span> <span class="err">단순히</span> <span class="nx">start</span><span class="p">()</span> <span class="err">메서드만</span> <span class="err">호출하면</span> <span class="err">됨</span>
</span></span></code></pre></div><p>프랑스어로 <code>건물의 외벽</code> 이라고 부르는 Facade 는 복잡한 시스템(엔티티의 직렬화) 를 간단한 인터페이스로 만들어서 사용하기 쉽게 만들 수 있습니다.</p>
<h3 id="그-결과-서비스-코드">그 결과 서비스 코드<a hidden class="anchor" aria-hidden="true" href="#그-결과-서비스-코드">#</a></h3>
<p>그 이후 서비스 코드들이 도메인 설정에 관한 로직이 간단해졌습니다.</p>
<h4 id="첫번째-예시--캡슐화를-통한-서비스에서의-도메인-관심-분리">첫번째 예시 : 캡슐화를 통한 서비스에서의 도메인 관심 분리<a hidden class="anchor" aria-hidden="true" href="#첫번째-예시--캡슐화를-통한-서비스에서의-도메인-관심-분리">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// 바뀐 서비스 코드 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">public</span> <span class="kr">async</span> <span class="nx">setProgress</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">status</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;cannot set progress&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getHost</span><span class="p">().</span><span class="nx">socketId</span> <span class="o">!==</span> <span class="nx">socketId</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;only host can set process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">)</span> <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>명시적으로 직렬화 하는 과정을 캡슐화함으로써, 로직 수행에만 집중할 수 있도록 만들었던 것 같습니다. 이전보다 할당문이 많이 줄었습니다. 이부분은 <code>getter setter</code> 를 두어서, 보다 일관되게 처리할 수 있습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="c1">// 이전 코드
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kr">public</span> <span class="kr">async</span> <span class="nx">setProgress</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">status</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;cannot set progress&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">socketId</span> <span class="o">!==</span> <span class="nx">socketId</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;only host can set process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">room</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">)</span> <span class="nx">room</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="두번째-예시--확장-가능한-dto-변환-로직의-생성-가능">두번째 예시 : 확장 가능한 DTO 변환 로직의 생성 가능<a hidden class="anchor" aria-hidden="true" href="#두번째-예시--확장-가능한-dto-변환-로직의-생성-가능">#</a></h4>
<p>두번째 예시입니다. 이는 <code>room-create.service.ts</code> 로 나누었던 함수입니다. 실제로 dto를 받고 객체로써 새로운 방을 레포지토리에 바로 엔티티로써 보내줄 수 없었던 단점을 해결할 수 있었습니다.</p>
<p>현재 보시면, 아래 코드의 큰 차이는 <code>엔티티로 넘겨주는</code> 지에 대한 여부의 차이입니다. 그냥 객체로 쓰면 안될까? 라고 할 수 있겠지만, 실제로 제가 원하는 시점에 언제 엔티티로 만들 수 있는지도 중요합니다.</p>
<p>최적화 여부도 있겠습니다. <code>repository</code> 에 업데이트를 자주해야하는 상황이 온다면, 이미 도메인 객체가 갖고 있는 엔티티를 리턴하면 됩니다. 이전 코드대로라면 <code>repository</code> 에 참조할 때마다 변환 과정이 무조건 일어나는 상황이 생깁니다.</p>
<p>또한 각각의 DTO는 동일한 역직렬화된 도메인으로부터 필요한 데이터를 꺼내올 수 있도록 만들 수 있었습니다. 적어도 <code>직렬화와 역직렬화</code> 라는 관심에서는 벗어난거죠. <code>DTO</code> 변환만을 위한 작업을 수행할 수 있게된 것입니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kd">@Transactional</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">createRoom</span><span class="p">(</span><span class="nx">dto</span>: <span class="kt">CreateRoomInternalDto</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">socketId</span><span class="p">,</span> <span class="nx">nickname</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">dto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">generateRoomId</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">socketService</span><span class="p">.</span><span class="nx">getSocket</span><span class="p">(</span><span class="nx">socketId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">questionList</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionListRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span>: <span class="kt">dto.questionListId</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">questionListContent</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionRepository</span><span class="p">.</span><span class="nx">getContentsByQuestionListId</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">dto</span><span class="p">.</span><span class="nx">questionListId</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">questionList</span><span class="p">.</span><span class="nx">usage</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionListRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">questionList</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">roomDto</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span><span class="nx">dto</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inProgress</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">connectionMap</span><span class="o">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListContents</span>: <span class="kt">questionListContent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createdAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxQuestionListLength</span>: <span class="kt">questionListContent.length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListTitle</span>: <span class="kt">questionList.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">currentIndex</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">socketId</span>: <span class="kt">dto.socketId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">createAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">roomDto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">EMIT_EVENT</span><span class="p">.</span><span class="nx">CREATE</span><span class="p">,</span> <span class="nx">roomDto</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kd">@Transactional</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">public</span> <span class="kr">async</span> <span class="nx">createRoom</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createRoomDto</span>: <span class="kt">CreateRoomDto</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span>: <span class="kt">Socket</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">CreateRoomResponseDto</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">questionData</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">useQuestionList</span><span class="p">(</span><span class="nx">createRoomDto</span><span class="p">.</span><span class="nx">questionListId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">roomObj</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">...</span><span class="nx">createRoomDto</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span>: <span class="kt">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">generateRoomId</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">inProgress</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">connectionMap</span><span class="o">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">        <span class="nx">participants</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">createdAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">maxQuestionListLength</span>: <span class="kt">questionData.content.length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">questionListTitle</span>: <span class="kt">questionData.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">currentIndex</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">host</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">socketId</span>: <span class="kt">socket.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nickname</span>: <span class="kt">createRoomDto.nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Room</span><span class="p">(</span><span class="nx">roomObj</span><span class="p">).</span><span class="nx">build</span><span class="p">();</span> <span class="c1">// 바뀐 코드에서는 굳이 엔티티를 변환하는 작업을 구현할 필요 없음
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">EMIT_EVENT</span><span class="p">.</span><span class="nx">CREATE</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">CreateRoomInternalDto</span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span> <span class="c1">// 리턴값을 엄밀히 설정
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h4 id="세번째-예시--역직렬화-상태를-유동적으로-저장-가능">세번째 예시 : 역직렬화 상태를 유동적으로 저장 가능<a hidden class="anchor" aria-hidden="true" href="#세번째-예시--역직렬화-상태를-유동적으로-저장-가능">#</a></h4>
<p>마지막으로, 받아온 엔티티를 언제든 역직렬화해서 하는 문법에 대한 책임이 분리될 수 있었습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">public</span> <span class="kr">async</span> <span class="nx">getPublicRoom</span><span class="p">(</span><span class="nx">inProgress?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomListResponseDto</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">rooms</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getAllRoom</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">filterFunction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">room</span>: <span class="kt">RoomEntity</span><span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">RoomStatus</span><span class="p">.</span><span class="nx">PUBLIC</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="nx">inProgress</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">room</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">===</span> <span class="nx">inProgress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">rooms</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">filterFunction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">room</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="nx">room</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">room</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span><span class="nx">room</span><span class="p">.</span><span class="nx">toObject</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span>: <span class="kt">room.getHost</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">room.getParticipants</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">connectionMap</span>: <span class="kt">undefined</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>심지어 이전 코드에서는 <code>엔티티에 존재하지 않는 정보를 레포지토리에서 가공하여 객체로 제공하고 있었습니다.</code> 이런 부분에서 책임 분리가 확실하게 될 수 있었던 것 같습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">public</span> <span class="kr">async</span> <span class="nx">getPublicRoom</span><span class="p">(</span><span class="nx">inProgress?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomListResponseDto</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">rooms</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getAllRoom</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">rooms</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nx">room</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">RoomStatus</span><span class="p">.</span><span class="nx">PUBLIC</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="nx">inProgress</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">room</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">===</span> <span class="nx">inProgress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">room</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createdAt</span>: <span class="kt">room.createdAt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span>: <span class="kt">room.host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxParticipants</span>: <span class="kt">room.maxParticipants</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">status</span>: <span class="kt">room.status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span>: <span class="kt">room.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span>: <span class="kt">room.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">category</span>: <span class="kt">room.category</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inProgress</span>: <span class="kt">room.inProgress</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListTitle</span>: <span class="kt">room.questionListTitle</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">room.participants</span><span class="p">,</span> <span class="c1">// 엔티티에는 없는 정보를 레포지토리가 가공하고 있었다!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="아직-남은-점">아직 남은 점<a hidden class="anchor" aria-hidden="true" href="#아직-남은-점">#</a></h3>
<h4 id="entity-프로퍼티를-public으로-열어두었다">Entity 프로퍼티를 public으로 열어두었다.<a hidden class="anchor" aria-hidden="true" href="#entity-프로퍼티를-public으로-열어두었다">#</a></h4>
<p>이렇게 보면, 도메인 객체의 상태가 언제든지 바뀔 수 있다는 위험이 있었습니다.</p>
<p>해당 부분의 경우 일일이 <code>setter</code>,  <code>getter</code> 를 도입하고, entity 객체 자체를 캡슐화하여 해결할 수 있었을 것이라고 생각합니다.</p>
<p>다만, 현재 리팩토링 대상인 도메인 객체의 프로퍼티 값이 <code>13</code>개 나 되어.. 차라리 구조적으로 개편하고 <code>setter</code> <code>getter</code> 를 적게 설정하는 방향도 좋을 것 같다고 생각이 들었습니다.</p>
<h4 id="외부-라이브러리를-수정해서-개선해보기">외부 라이브러리를 수정해서 개선해보기<a hidden class="anchor" aria-hidden="true" href="#외부-라이브러리를-수정해서-개선해보기">#</a></h4>
<p><code>@moozeh/nestjs-redis-om</code> 라이브러리를 제가 직접 포크해온 만큼, 제가 편하게 쓸 수 있도록 개선할 수 있었을 것입니다. 시간과 비용을 생각해서 제가 편하게 쓸 수 없어서 아쉬울 따름입니다..</p>
<h3 id="참고자료">참고자료<a hidden class="anchor" aria-hidden="true" href="#참고자료">#</a></h3>
<ul>
<li><a href="https://appleg1226.tistory.com/40">https://appleg1226.tistory.com/40</a></li>
</ul>
<h2 id="문제-해결-과정-2-클린코드에-대해서--어떤게-문제인지-확실히-파악하기">문제 해결 과정 2. 클린코드에 대해서 : 어떤게 문제인지 확실히 파악하기<a hidden class="anchor" aria-hidden="true" href="#문제-해결-과정-2-클린코드에-대해서--어떤게-문제인지-확실히-파악하기">#</a></h2>
<p>클린코드에 대해서 <code>경계</code> 할 것이 아니라, <strong>어떤게 문제인지 확실히 아는 프로그래머가 되는 게 중요하다</strong>고 생각하게된 <a href="https://www.youtube.com/watch?v=HoP8qWpucWA">영상</a>을 보았습니다.</p>
<p>포프님의 영상에 달린 댓글에 이런 내용이 눈에 들어왔고, 스스로 어떻게 해야 협업할 수 있는 개발자인지 생각해보려고 합니다.</p>
<blockquote>
<p>어떤 업무건 업의 본질이라는 게 있습니다.</p>
<p>프로그래밍 또한 업의 본질을 이해해야 한다고 생각합니다.</p>
<p>효율적인 업무 진행을 위한 서로간의 조율이 필요합니다. TDD를 써야하면 그렇게 해야하고, 다른 방법론이 있다면 그것을 적용하고..</p></blockquote>
<p>따라서 앞서 제가 진행했던 스터디 세션 부분 리팩토링과 같은 부분은 팀을 위한 조율이 아니라고 생각했습니다. 그 후부터는 최대한 <code>팀의 가치</code> 에 집중했고, 이것이 진정한 본질이 아닐까 한번 생각을 해보게 됐습니다.</p>
<p>아직 많이 부족하지만, 아래 글에서 처럼, 협업의 가치를 조금씩 깨달아가고 있음을 스스로 느끼고 있습니다.</p>
<p><a href="https://blog.moozeh.org/posts/jwt-%ED%86%A0%ED%81%B0-%ED%8C%8C%EC%8B%B1-%EB%B3%80%EA%B2%BD-%EA%B3%BC%EC%A0%95%EA%B3%BC-%ED%98%91%EC%97%85%EC%9D%98-%EA%B0%80%EC%B9%98%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC">JWT 토큰 파싱 변경 과정과 협업의 가치에 대한 고민</a></p>
<h3 id="협업을-위한-더러운-코드">협업을 위한 더러운 코드<a hidden class="anchor" aria-hidden="true" href="#협업을-위한-더러운-코드">#</a></h3>
<p>200줄이나 되는 코드를 직접 올려보겠습니다.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@nestjs/common&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomEntity</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.entity&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.repository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomListResponseDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/all-room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Socket</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;socket.io&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">CreateRoomDto</span><span class="p">,</span> <span class="nx">CreateRoomResponseDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/create-room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">JoinRoomDto</span><span class="p">,</span> <span class="nx">JoinRoomResponseDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/join-room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Transactional</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;typeorm-transactional&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Room</span><span class="p">,</span> <span class="nx">RoomStatus</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/domain/room&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">EMIT_EVENT</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.events&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">createHash</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;node:crypto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">QuestionRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/question-list/repository/question.respository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">FullRoomException</span><span class="p">,</span> <span class="nx">InProgressException</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/exceptions/join-room-exceptions&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">InfraService</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/infra/infra.service&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">QuestionListRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/question-list/repository/question-list.repository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Injectable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RoomService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">ROOM_ID_CREATE_KEY</span> <span class="o">=</span> <span class="s2">&#34;room_id&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">roomRepository</span>: <span class="kt">RoomRepository</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">infraService</span>: <span class="kt">InfraService</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">questionListRepository</span>: <span class="kt">QuestionListRepository</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">questionRepository</span>: <span class="kt">QuestionRepository</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">leaveRoom</span><span class="p">(</span><span class="nx">socket</span>: <span class="kt">Socket</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">rooms</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">infraService</span><span class="p">.</span><span class="nx">getSocketMetadata</span><span class="p">(</span><span class="nx">socket</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">await</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">roomId</span> <span class="k">of</span> <span class="nx">rooms</span><span class="p">.</span><span class="nx">joinedRooms</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">processRoomLeave</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">roomId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@Transactional</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">createRoom</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">createRoomDto</span>: <span class="kt">CreateRoomDto</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">socket</span>: <span class="kt">Socket</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">CreateRoomResponseDto</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">currentTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">questionData</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">useQuestionList</span><span class="p">(</span><span class="nx">createRoomDto</span><span class="p">.</span><span class="nx">questionListId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">roomObj</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span><span class="nx">createRoomDto</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span>: <span class="kt">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">generateRoomId</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">inProgress</span>: <span class="kt">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">connectionMap</span><span class="o">:</span> <span class="p">{},</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createdAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">maxQuestionListLength</span>: <span class="kt">questionData.content.length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListTitle</span>: <span class="kt">questionData.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">currentIndex</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">host</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">socketId</span>: <span class="kt">socket.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">nickname</span>: <span class="kt">createRoomDto.nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">createAt</span>: <span class="kt">currentTime</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Room</span><span class="p">(</span><span class="nx">roomObj</span><span class="p">).</span><span class="nx">build</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">EMIT_EVENT</span><span class="p">.</span><span class="nx">CREATE</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nickname</span>: <span class="kt">createRoomDto.nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListContents</span>: <span class="kt">questionData.content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">socketId</span>: <span class="kt">socket.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span><span class="nx">roomObj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">joinRoom</span><span class="p">(</span><span class="nx">joinRoomDto</span>: <span class="kt">JoinRoomDto</span><span class="p">,</span> <span class="nx">socket</span>: <span class="kt">Socket</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">JoinRoomResponseDto</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="p">{</span> <span class="nx">roomId</span><span class="p">,</span> <span class="nx">nickname</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">joinRoomDto</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">socket</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;Invalid Socket&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;RoomEntity Not found&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">infraService</span><span class="p">.</span><span class="nx">joinRoom</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">InProgressException</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isFullRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">))</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">FullRoomException</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">addConnection</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">socketId</span>: <span class="kt">socket.id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">createAt</span>: <span class="kt">Date.now</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">questionListContents</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionRepository</span><span class="p">.</span><span class="nx">getContentsByQuestionListId</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">questionListId</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">toObject</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">connectionMap</span><span class="p">[</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">participants</span>: <span class="kt">room.getParticipants</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">            <span class="p">...</span><span class="nx">obj</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">questionListContents</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getPublicRoom</span><span class="p">(</span><span class="nx">inProgress?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomListResponseDto</span><span class="err">[]</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">rooms</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getAllRoom</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">filterFunction</span> <span class="o">=</span> <span class="p">(</span><span class="nx">room</span>: <span class="kt">RoomEntity</span><span class="p">)</span> <span class="o">=&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">room</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="nx">RoomStatus</span><span class="p">.</span><span class="nx">PUBLIC</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="nx">inProgress</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">room</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">===</span> <span class="nx">inProgress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">rooms</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">filterFunction</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createdAt</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">room</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="nx">room</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">room</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
</span></span><span class="line"><span class="cl">                <span class="p">...</span><span class="nx">room</span><span class="p">.</span><span class="nx">toObject</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">host</span>: <span class="kt">room.getHost</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">participants</span>: <span class="kt">room.getParticipants</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">connectionMap</span>: <span class="kt">undefined</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">}));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">setProgress</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">status</span>: <span class="kt">boolean</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;cannot set progress&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getHost</span><span class="p">().</span><span class="nx">socketId</span> <span class="o">!==</span> <span class="nx">socketId</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;only host can set process&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">=</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">)</span> <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">setIndex</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">index</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO : 리팩토링 할 필요가 있어보임.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="nx">room</span><span class="p">.</span><span class="nx">getHost</span><span class="p">().</span><span class="nx">socketId</span> <span class="o">!==</span> <span class="nx">socketId</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="nx">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">maxQuestionListLength</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getIndex</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">)).</span><span class="nx">currentIndex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">increaseIndex</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span> <span class="o">||</span> <span class="nx">room</span><span class="p">.</span><span class="nx">getHost</span><span class="p">().</span><span class="nx">socketId</span> <span class="o">!==</span> <span class="nx">socketId</span> <span class="o">||</span> <span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">inProgress</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">index</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">setIndex</span><span class="p">(</span><span class="nx">roomId</span><span class="p">,</span> <span class="nx">socketId</span><span class="p">,</span> <span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getIndex</span><span class="p">(</span><span class="nx">roomId</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">index</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">maxQuestionListLength</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">finishRoom</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">removeRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">roomId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">processRoomLeave</span><span class="p">(</span><span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">room</span> <span class="o">=</span> <span class="nx">Room</span><span class="p">.</span><span class="nx">fromEntity</span><span class="p">(</span><span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">getRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">removeConnection</span><span class="p">(</span><span class="nx">socketId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">()).</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">deleteRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getHost</span><span class="p">().</span><span class="nx">socketId</span> <span class="o">===</span> <span class="nx">socketId</span><span class="p">)</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleHostChange</span><span class="p">(</span><span class="nx">socketId</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">infraService</span><span class="p">.</span><span class="nx">emitToRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">,</span> <span class="nx">EMIT_EVENT</span><span class="p">.</span><span class="nx">QUIT</span><span class="p">,</span> <span class="p">{</span> <span class="nx">socketId</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">handleHostChange</span><span class="p">(</span><span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getHost</span><span class="p">().</span><span class="nx">socketId</span> <span class="o">!==</span> <span class="nx">socketId</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">newHost</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">delegateHost</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO : throw new Exception : host changed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// 에러를 던지는 방식이 아닌 다른 방식으로 해결해야함.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">this</span><span class="p">.</span><span class="nx">infraService</span><span class="p">.</span><span class="nx">emitToRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">EMIT_EVENT</span><span class="p">.</span><span class="nx">CHANGE_HOST</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">nickname</span>: <span class="kt">newHost.nickname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">socketId</span>: <span class="kt">newHost.socketId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">deleteRoom</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">removeRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="p">.</span><span class="nx">infraService</span><span class="p">.</span><span class="nx">emitToRoom</span><span class="p">(</span><span class="nx">roomId</span><span class="p">,</span> <span class="nx">EMIT_EVENT</span><span class="p">.</span><span class="nx">QUIT</span><span class="p">,</span> <span class="p">{</span> <span class="nx">roomId</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getNewHost</span><span class="p">(</span><span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">()).</span><span class="nx">sort</span><span class="p">((</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">createAt</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createAt</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">delegateHost</span><span class="p">(</span><span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">newHost</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getNewHost</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">found</span> <span class="o">=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">()[</span><span class="nx">newHost</span><span class="p">.</span><span class="nx">socketId</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&#34;invalid new host id&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">room</span><span class="p">.</span><span class="nx">setHost</span><span class="p">(</span><span class="nx">newHost</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomRepository</span><span class="p">.</span><span class="nx">setRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">newHost</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">isFullRoom</span><span class="p">(</span><span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">room</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">maxParticipants</span> <span class="o">&lt;=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getConnection</span><span class="p">()).</span><span class="nx">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@Transactional</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">useQuestionList</span><span class="p">(</span><span class="nx">questionListId</span>: <span class="kt">number</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">questionData</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionListRepository</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">            <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span>: <span class="kt">questionListId</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">questions</span> <span class="o">=</span> <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionRepository</span><span class="p">.</span><span class="nx">getContentsByQuestionListId</span><span class="p">(</span><span class="nx">questionListId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">questionData</span><span class="p">.</span><span class="nx">usage</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">questionListRepository</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">questionData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">title</span>: <span class="kt">questionData.title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">content</span>: <span class="kt">questions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: 동시성 고려해봐야하지 않을까?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">generateRoomId() {</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">infraService</span><span class="p">.</span><span class="nx">getRedisClient</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">idString</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="kr">get</span><span class="p">(</span><span class="nx">RoomService</span><span class="p">.</span><span class="nx">ROOM_ID_CREATE_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">id</span>: <span class="kt">number</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">idString</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">idString</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">incr</span><span class="p">(</span><span class="nx">RoomService</span><span class="p">.</span><span class="nx">ROOM_ID_CREATE_KEY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="nx">RoomService</span><span class="p">.</span><span class="nx">ROOM_ID_CREATE_KEY</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">createHash</span><span class="p">(</span><span class="s2">&#34;sha256&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">id</span> <span class="o">+</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SESSION_HASH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&#34;hex&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>보시기엔 더러울 수 있습니다.</p>
<p>하지만 인터페이스를 볼까요?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-tsx" data-lang="tsx"><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@nestjs/common&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomEntity</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.entity&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.repository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">RoomListResponseDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/all-room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Socket</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;socket.io&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">CreateRoomDto</span><span class="p">,</span> <span class="nx">CreateRoomResponseDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/create-room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">JoinRoomDto</span><span class="p">,</span> <span class="nx">JoinRoomResponseDto</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/dto/join-room.dto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Transactional</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;typeorm-transactional&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">Room</span><span class="p">,</span> <span class="nx">RoomStatus</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/domain/room&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">EMIT_EVENT</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/room.events&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">createHash</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;node:crypto&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">QuestionRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/question-list/repository/question.respository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">FullRoomException</span><span class="p">,</span> <span class="nx">InProgressException</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/room/exceptions/join-room-exceptions&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">InfraService</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/infra/infra.service&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kr">import</span> <span class="p">{</span> <span class="nx">QuestionListRepository</span> <span class="p">}</span> <span class="kr">from</span> <span class="s2">&#34;@/question-list/repository/question-list.repository&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">@Injectable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">export</span> <span class="kr">class</span> <span class="nx">RoomService</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">static</span> <span class="nx">ROOM_ID_CREATE_KEY</span> <span class="o">=</span> <span class="s2">&#34;room_id&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">constructor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">roomRepository</span>: <span class="kt">RoomRepository</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">infraService</span>: <span class="kt">InfraService</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">questionListRepository</span>: <span class="kt">QuestionListRepository</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="kr">private</span> <span class="kr">readonly</span> <span class="nx">questionRepository</span>: <span class="kt">QuestionRepository</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">leaveRoom</span><span class="p">(</span><span class="nx">socket</span>: <span class="kt">Socket</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">@Transactional</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">createRoom</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">createRoomDto</span>: <span class="kt">CreateRoomDto</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">socket</span>: <span class="kt">Socket</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">CreateRoomResponseDto</span><span class="p">&gt;</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">joinRoom</span><span class="p">(</span><span class="nx">joinRoomDto</span>: <span class="kt">JoinRoomDto</span><span class="p">,</span> <span class="nx">socket</span>: <span class="kt">Socket</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">JoinRoomResponseDto</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getPublicRoom</span><span class="p">(</span><span class="nx">inProgress?</span>: <span class="kt">boolean</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="p">&lt;</span><span class="nt">RoomListResponseDto</span><span class="err">[]</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">finishRoom</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">setProgress</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">status</span>: <span class="kt">boolean</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">setIndex</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">index</span>: <span class="kt">number</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">getIndex</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="kr">public</span> <span class="kr">async</span> <span class="nx">increaseIndex</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">socketId</span>: <span class="kt">string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">processRoomLeave</span><span class="p">(</span><span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">handleHostChange</span><span class="p">(</span><span class="nx">socketId</span>: <span class="kt">string</span><span class="p">,</span> <span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">deleteRoom</span><span class="p">(</span><span class="nx">roomId</span>: <span class="kt">string</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">getNewHost</span><span class="p">(</span><span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">delegateHost</span><span class="p">(</span><span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="nx">isFullRoom</span><span class="p">(</span><span class="nx">room</span>: <span class="kt">Room</span><span class="p">)</span><span class="o">:</span> <span class="kr">boolean</span> 
</span></span><span class="line"><span class="cl">    <span class="kd">@Transactional</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">useQuestionList</span><span class="p">(</span><span class="nx">questionListId</span>: <span class="kt">number</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// TODO: 동시성 고려해봐야하지 않을까?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kr">private</span> <span class="kr">async</span> <span class="nx">generateRoomId</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>작업을 위한 <code>private</code> 함수들을 제외하고 보았을 때, 방에 대한 <code>CRUD</code>, 즉 일종의 방에 대한 연산 작업이 한곳에 모여있음을 알 수 있습니다.</p>
<p>다른 파일에서 해당 클래스의 인터페이스를 확인해보면 생각보다 함수가 별로 없음을 알 수 있습니다.</p>
<h2 id="핵심-가치">핵심 가치<a hidden class="anchor" aria-hidden="true" href="#핵심-가치">#</a></h2>
<p>결국에는 중요한 것은 코드의 길이가 아니라 <code>인터페이스</code> 라는 겁니다.. 그렇게 문제를 해결할 수 있었고, 실제로 외부 파일인 핸들러에서 사용할 때 일관되게 사용할 수 있었습니다.</p>
<p>또한, 한 데에 파일을 모아보니, 오히려 서비스의 수가 줄어서 모듈의 크기가 줄었습니다.</p>


    </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.blu3fishez.org/tags/clean_code/">Clean_code</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://blog.blu3fishez.org/posts/2024/2024-12-21-custom-passport-%EB%A1%9C-github-oauth-%EB%A1%9C%EC%A7%81%EC%9D%84-%EC%A7%81%EC%A0%91-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0/">
    <span class="title">« Prev</span>
    <br>
    <span>Custom Passport 로 Github OAuth 로직을 직접 구현하기</span>
  </a>
  <a class="next" href="https://blog.blu3fishez.org/posts/2024/2024-10-27-boj-6064-%EC%B9%B4%EC%9E%89-%EB%8B%AC%EB%A0%A5/">
    <span class="title">Next »</span>
    <br>
    <span>[ 백준 6064 ] 카잉 달력 : C&#43;&#43; 풀이</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© <a href="https://github.com/blu3fishez">blu3fishez</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
